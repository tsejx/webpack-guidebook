<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/webpack-guidebook/umi.331878c1.css" />
    <script>
      window.routerBase = "/webpack-guidebook/";
    </script>
    <script>
      //! umi version: 3.5.20
    </script>
    <script>
      !(function () {
        var e = localStorage.getItem("dumi:prefers-color"),
          t = window.matchMedia("(prefers-color-scheme: dark)").matches,
          r = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === r[2] ? (t ? r[1] : r[0]) : r.indexOf(e) > -1 ? e : r[0]
        );
      })();
    </script>
    <title>构建优化总结 - Webpack Guidebook</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/best-practice/optimization/collection" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/webpack-guidebook-favicon.svg&#x27;)" href="/webpack-guidebook//">Webpack Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span><a href="/webpack-guidebook//basic">基本综述</a></span><span><a href="/webpack-guidebook//infra">架构原理</a></span><span><a aria-current="page" class="active" href="/webpack-guidebook//best-practice">最佳实践</a></span><span><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/webpack-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/webpack-guidebook-favicon.svg&#x27;)" href="/webpack-guidebook//"></a><h1>Webpack Guidebook</h1><p>Webpack 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/webpack-guidebook//basic">基本综述</a></li><li><a href="/webpack-guidebook//infra">架构原理</a></li><li><a aria-current="page" class="active" href="/webpack-guidebook//best-practice">最佳实践</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/webpack-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a target="_blank" rel="noopener noreferrer">实战应用</a><ul><li><a href="/webpack-guidebook//best-practice/practical-application/composing-webpack-configuration"><span>组合配置</span></a></li><li><a href="/webpack-guidebook//best-practice/practical-application/loading-style"><span>加载样式</span></a></li><li><a href="/webpack-guidebook//best-practice/practical-application/loading-images"><span>加载图片</span></a></li><li><a href="/webpack-guidebook//best-practice/practical-application/loading-fonts"><span>加载字体</span></a></li><li><a href="/webpack-guidebook//best-practice/practical-application/loading-javascript"><span>加载脚本</span></a></li><li><a href="/webpack-guidebook//best-practice/practical-application/environment-variables"><span>环境变量</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">构建优化</a><ul><li><a href="/webpack-guidebook//best-practice/optimization/build-analyze"><span>构建分析</span></a></li><li><a href="/webpack-guidebook//best-practice/optimization/exclude-build-target"><span>缩小构建目标</span></a></li><li><a href="/webpack-guidebook//best-practice/optimization/precompile"><span>预编译资源模块</span></a></li><li><a href="/webpack-guidebook//best-practice/optimization/build-cache-strategy"><span>构建缓存策略</span></a></li><li><a href="/webpack-guidebook//best-practice/optimization/multi-process"><span>多进程/多线程优化</span></a></li><li><a href="/webpack-guidebook//best-practice/optimization/bundle-spliting"><span>分割打包 Bundle Spliting</span></a></li><li><a href="/webpack-guidebook//best-practice/optimization/code-splitting"><span>代码拆分 Code Spliting</span></a></li><li><a href="/webpack-guidebook//best-practice/optimization/minifying"><span>压缩代码</span></a></li><li><a href="/webpack-guidebook//best-practice/optimization/dynamic-polyfill"><span>动态 Ployfill</span></a></li><li><a aria-current="page" class="active" href="/webpack-guidebook//best-practice/optimization/collection"><span>构建优化总结</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">扩展资料</a><ul><li><a href="/webpack-guidebook//best-practice/extensions/overview"><span>推荐资料</span></a></li><li><a href="/webpack-guidebook//best-practice/extensions/loaders"><span>加载器合集</span></a></li><li><a href="/webpack-guidebook//best-practice/extensions/plugins"><span>插件合集</span></a></li></ul></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="优化构建速度" data-depth="2"><a href="/webpack-guidebook//best-practice/optimization/collection#优化构建速度"><span>优化构建速度</span></a></li><li title="缩小文件的搜索范围" data-depth="3"><a href="/webpack-guidebook//best-practice/optimization/collection#缩小文件的搜索范围"><span>缩小文件的搜索范围</span></a></li><li title="使用 DllPlugin 减少基础模块编译次数" data-depth="3"><a href="/webpack-guidebook//best-practice/optimization/collection#使用-dllplugin-减少基础模块编译次数"><span>使用 DllPlugin 减少基础模块编译次数</span></a></li><li title="使用 HappyPack 开启多进程 Loader 转换" data-depth="3"><a href="/webpack-guidebook//best-practice/optimization/collection#使用-happypack-开启多进程-loader-转换"><span>使用 HappyPack 开启多进程 Loader 转换</span></a></li><li title="使用 ParallelUglifyPlugin 开启多进程压缩 JS 文件" data-depth="3"><a href="/webpack-guidebook//best-practice/optimization/collection#使用-paralleluglifyplugin-开启多进程压缩-js-文件"><span>使用 ParallelUglifyPlugin 开启多进程压缩 JS 文件</span></a></li><li title="优化开发体验" data-depth="2"><a href="/webpack-guidebook//best-practice/optimization/collection#优化开发体验"><span>优化开发体验</span></a></li><li title="使用自动刷新" data-depth="3"><a href="/webpack-guidebook//best-practice/optimization/collection#使用自动刷新"><span>使用自动刷新</span></a></li><li title="开启模块热替换 HMR" data-depth="3"><a href="/webpack-guidebook//best-practice/optimization/collection#开启模块热替换-hmr"><span>开启模块热替换 HMR</span></a></li><li title="devtool" data-depth="3"><a href="/webpack-guidebook//best-practice/optimization/collection#devtool"><span>devtool</span></a></li><li title="避免使用构建时才使用到的工具" data-depth="3"><a href="/webpack-guidebook//best-practice/optimization/collection#避免使用构建时才使用到的工具"><span>避免使用构建时才使用到的工具</span></a></li><li title="不要输出路径信息" data-depth="3"><a href="/webpack-guidebook//best-practice/optimization/collection#不要输出路径信息"><span>不要输出路径信息</span></a></li><li title="关闭部分构建优化" data-depth="3"><a href="/webpack-guidebook//best-practice/optimization/collection#关闭部分构建优化"><span>关闭部分构建优化</span></a></li><li title="优化输出质量 - 压缩文件体积" data-depth="2"><a href="/webpack-guidebook//best-practice/optimization/collection#优化输出质量---压缩文件体积"><span>优化输出质量 - 压缩文件体积</span></a></li><li title="区分环境：减少生产环境代码体积" data-depth="3"><a href="/webpack-guidebook//best-practice/optimization/collection#区分环境减少生产环境代码体积"><span>区分环境：减少生产环境代码体积</span></a></li><li title="压缩代码：JS、ES、CSS" data-depth="3"><a href="/webpack-guidebook//best-practice/optimization/collection#压缩代码jsescss"><span>压缩代码：JS、ES、CSS</span></a></li><li title="使用 TreeShaking 去除无效代码" data-depth="3"><a href="/webpack-guidebook//best-practice/optimization/collection#使用-treeshaking-去除无效代码"><span>使用 TreeShaking 去除无效代码</span></a></li><li title="公共代码提取" data-depth="3"><a href="/webpack-guidebook//best-practice/optimization/collection#公共代码提取"><span>公共代码提取</span></a></li><li title="压缩和混淆" data-depth="3"><a href="/webpack-guidebook//best-practice/optimization/collection#压缩和混淆"><span>压缩和混淆</span></a></li><li title="优化输出质量 - 加速网络请求" data-depth="2"><a href="/webpack-guidebook//best-practice/optimization/collection#优化输出质量---加速网络请求"><span>优化输出质量 - 加速网络请求</span></a></li><li title="使用 CDN 加速静态资源加载" data-depth="3"><a href="/webpack-guidebook//best-practice/optimization/collection#使用-cdn-加速静态资源加载"><span>使用 CDN 加速静态资源加载</span></a></li><li title="多页面应用提取页面间公共代码" data-depth="3"><a href="/webpack-guidebook//best-practice/optimization/collection#多页面应用提取页面间公共代码"><span>多页面应用提取页面间公共代码</span></a></li><li title="分割代码以按需加载" data-depth="3"><a href="/webpack-guidebook//best-practice/optimization/collection#分割代码以按需加载"><span>分割代码以按需加载</span></a></li><li title="长缓存优化" data-depth="3"><a href="/webpack-guidebook//best-practice/optimization/collection#长缓存优化"><span>长缓存优化</span></a></li><li title="优化输出质量 - 提升代码运行时效率" data-depth="2"><a href="/webpack-guidebook//best-practice/optimization/collection#优化输出质量---提升代码运行时效率"><span>优化输出质量 - 提升代码运行时效率</span></a></li><li title="使用 Prepack 提前求值" data-depth="3"><a href="/webpack-guidebook//best-practice/optimization/collection#使用-prepack-提前求值"><span>使用 Prepack 提前求值</span></a></li><li title="使用 Scope Hoisting" data-depth="3"><a href="/webpack-guidebook//best-practice/optimization/collection#使用-scope-hoisting"><span>使用 Scope Hoisting</span></a></li><li title="使用输出分析工具" data-depth="2"><a href="/webpack-guidebook//best-practice/optimization/collection#使用输出分析工具"><span>使用输出分析工具</span></a></li><li title="官方工具 WebpackAnalyse" data-depth="3"><a href="/webpack-guidebook//best-practice/optimization/collection#官方工具-webpackanalyse"><span>官方工具 WebpackAnalyse</span></a></li><li title="webpack-bundle-analyzer" data-depth="3"><a href="/webpack-guidebook//best-practice/optimization/collection#webpack-bundle-analyzer"><span>webpack-bundle-analyzer</span></a></li><li title="补充说明" data-depth="2"><a href="/webpack-guidebook//best-practice/optimization/collection#补充说明"><span>补充说明</span></a></li><li title="Babel" data-depth="3"><a href="/webpack-guidebook//best-practice/optimization/collection#babel"><span>Babel</span></a></li><li title="其他方法" data-depth="2"><a href="/webpack-guidebook//best-practice/optimization/collection#其他方法"><span>其他方法</span></a></li><li title="参考文章" data-depth="2"><a href="/webpack-guidebook//best-practice/optimization/collection#参考文章"><span>参考文章</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="构建优化总结"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#构建优化总结"><span class="icon icon-link"></span></a>构建优化总结</h1><p><strong>打包速度优化</strong></p><ul><li>文件多？业务复杂 语法分析多</li><li>依赖多？提取公共代码</li><li>页面多？操作耗时的编译方式</li></ul><h2 id="优化构建速度"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#优化构建速度"><span class="icon icon-link"></span></a>优化构建速度</h2><p>Webpack 在启动后会根据 <code>entry</code> 配置的入口出发，递归地解析所依赖的文件。这个过程分为 <strong style="color:red">搜索文件</strong> 和 <strong style="color:red">把匹配的文件进行分析、转化</strong> 的两个过程，因此可以从这两个角度来进行优化配置。</p><h3 id="缩小文件的搜索范围"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#缩小文件的搜索范围"><span class="icon icon-link"></span></a>缩小文件的搜索范围</h3><p>Webpack 在启动后从配置 <code>entry</code> 出发，解析文中导入语句，再递归解析，在遇到导入语句时：</p><ul><li>根据导入语句去寻找对应的要导入的文件</li><li>根据找到的要导入的文件的后缀，使用配置中的 Loader 去处理文件。例如使用 ES6 开发的 JavaScript 文件需要使用 babel-loader 处理 。</li></ul><h4 id="resolve"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#resolve"><span class="icon icon-link"></span></a>resolve</h4><h5 id="resolvemodules"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#resolvemodules"><span class="icon icon-link"></span></a>resolve.modules</h5><p>设置 <code>resolve.modules</code> 指定第三方模块存放的绝对路径，避免层层查找，减少搜索步骤。</p><p>该配置默认值为 <code>[&#x27;node_modules&#x27;]</code>，会依次查找 <code>./node_modules</code>、<code>../node_modules</code>、<code>../../node_modules</code>。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">//...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  resolve</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    modules</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">path</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token plain">__dirname</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;node_modules&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><h5 id="resolvemainfields"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#resolvemainfields"><span class="icon icon-link"></span></a>resolve.mainFields</h5><p>设置 <code>resolve.mainFileds: [&#x27;main&#x27;]</code> 设置尽量少的值可以减少入口文件的搜索步骤。</p><p>例如：isomorphic-fetch</p><p>由于不同运行环境 fetch API 实现机制不一致。</p><div class="__dumi-default-code-block"><pre class="prism-code language-json"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token property">&quot;browser&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;fetch-npm-browserify.js&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token property">&quot;main&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;fetch-npm-node.js&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p><code>mainFields</code> 决定导入第三方模块在 <code>package.json</code> 中是用哪个字段导入模块。根据 Webpack 配置中指定的 <code>target</code> 运行环境的不同，默认值也会有所不同。</p><p>因此，可以设置单独 <code>main</code> 值能更准确命中包入口字段。</p><ul><li>target 为 web 或 webworker 时，值是 <code>[&#x27;browser&#x27;, &#x27;module&#x27;, &#x27;main&#x27;]</code></li><li>target 为 其他情况时，值是 <code>[&#x27;module&#x27;, &#x27;main&#x27;]</code></li></ul><h5 id="resolvealias"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#resolvealias"><span class="icon icon-link"></span></a>resolve.alias</h5><p>设置 <code>resolve.alias</code> 能让 Webpack 直接使用第三方模块的压缩版本，不再对库进行解析，还可以使用别名方便引用文件。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">//...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  resolve</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    alias</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token maybe-class-name">Components</span><span class="token operator">:</span><span class="token plain"> path</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token plain">__dirname</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;src/components/&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token maybe-class-name">Utils</span><span class="token operator">:</span><span class="token plain"> path</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token plain">__dirname</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;src/utils/&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      react</span><span class="token operator">:</span><span class="token plain"> path</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token plain">__dirname</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;./node_modules/react/dist/react.min.js&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><p>例如这样就可以直接使用 React 的压缩版本，每次构建时不必再次解析。还可以通过别名引用文件，而不必再打复杂的引用路径。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword module">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">ReactComponent</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;Components/ReactComponent&#x27;</span><span class="token punctuation">;</span></div></pre></div><p><strong>应用于 React</strong></p><p>发布出去的 React 库中包含两套代码。</p><ul><li>一套采用 CommonJS 规范的模块化代码，这些文件都放在 lib 目录下，以 package.json 中指定的入口文件 react.js 为模块入口</li><li>一套是将 React 的相关代码打包好的完整代码放到一个单独的文件中，这些代码没有采用模块化，可以直接执行。其中 dist/react.js 用于开发环境，里面包含检查和警告代码。dist/react.min.js 用于线上环境，被最小化了。</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// webpack.config.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  resolve</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 使用 alias 将导入 react 的语句换成直接使用单独、完整的 react.min.js 文件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 减少耗时的递归解析操作</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    alias</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      react</span><span class="token operator">:</span><span class="token plain"> path</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token plain">__dirname</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;./node_modules/react/dist/react.min.js&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><p>但这样设置的缺点是会无法使用 Tree-Shaking 优化输出的打包文件，所以一般对 React 这种整体性比较强的使用比较好，而像 lodash 这样的工具库还是建议使用 Tree-Shaking 去除多余代码。</p><h5 id="resolveextensions"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#resolveextensions"><span class="icon icon-link"></span></a>resolve.extensions</h5><p><code>resolve.extensions</code> 用于确定需要 Webpack 解析的文件类型，指定文件扩展名能加快寻找速度。而当导入语句没带文件后缀时，Webpack 会根据 extensions 定义的扩展名列表进行文件查找。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 默认</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  resolve</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    extensions</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;.wasm&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;.mjs&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;.js&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;.json&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 改进</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  resolve</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    extensions</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;.js&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;.json&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;jsx&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><p>同时，也能够在引入模块时不带扩展。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword module">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">File</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;../path/file&#x27;</span><span class="token punctuation">;</span></div></pre></div><p><strong>总结</strong></p><ul><li>列表值尽量少</li><li>频率高的文件扩展名写在前面</li><li>源码中的导入语句尽可能的加上文件后缀，如 <code>require(./data)</code> 要写成 <code>require(./data.json)</code></li></ul><h4 id="modulenoparse"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#modulenoparse"><span class="icon icon-link"></span></a><code>module.noParse</code></h4><p><code>module.noParse</code> 配置项能让 Webpack 忽略那些文件，可用于排除对非模块化库文件的解析。</p><p>如 jQuery、ChartJS 一些没有采用模块化标准的库，另外如果是用 <code>resovle.alias</code> 配置了 <code>react.min.js</code>，则也应该排除解析，因为 <code>react.min.js</code> 已是经过构建，并且可直接运行在浏览器的、非模块化的文件。</p><p><code>module.noParse</code> 可以是 <code>RegExp</code>、<code>[RegExp]</code>、<code>function</code></p><p>注意，被忽略掉的文件里不应该包含 import、 require、 define 等模块化语句，不 然会导致在构建出的代码中包含无法在浏览器环境下执行的模块化语句。</p><h4 id="loader"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#loader"><span class="icon icon-link"></span></a><code>loader</code></h4><ul><li>尽量少使用不同的 loader / plugins</li><li>使用 <code>include</code> 配置项指明要转换的文件目录，使用 <code>exclude</code> 排除不必解析的文件目录</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  module</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    rules</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        test</span><span class="token operator">:</span><span class="token plain"> </span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">\.js$</span><span class="token regex regex-delimiter">/</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        include</span><span class="token operator">:</span><span class="token plain"> path</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token plain">__dirname</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;src&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        exclude</span><span class="token operator">:</span><span class="token plain"> path</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token plain">__dirname</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;node_modules&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        loader</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;babel-loader&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><h3 id="使用-dllplugin-减少基础模块编译次数"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#使用-dllplugin-减少基础模块编译次数"><span class="icon icon-link"></span></a>使用 DllPlugin 减少基础模块编译次数</h3><p>DllPlugin 动态链接库插件，其原理是把网页依赖的基础模块抽离出来打包到 dll 文件中，当需要导入的模块存在于某个 dll 中时，这个模块不再被打包，而是去 dll 中获取。</p><p>由于 dll 中大多包含的是常用的第三方模块，如 react、react-dom，所以只要这些模块版本不升级，就只需被编译一次，在之后的构建过程中被动态链接库包含的模块将不会重新编译，而是直接使用动态链接库中的代码。</p><p>我认为这样做和配置 <code>resolve.alias</code> 和 <code>module.noParse</code> 的效果有异曲同工的效果。</p><p><strong>使用方法：</strong></p><p>准备两个插件：</p><ul><li>DllPlugin - 用于打包出一个个单独的动态链接库文件</li><li>DllReferencePlugin - 用于在主要的配置文件中引入 DllPlugin 插件打包好的动态链接库文件</li></ul><ol><li>使用 DllPlguin 配置一个 webpack_dll.config.js 来构建 dll 文件</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// webpack_dll.config.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> path </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;path&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  entry</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    react</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;react&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;react-dom&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    polyfill</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;core-js/fn/promise&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;whatwg-fetch&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  output</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    filename</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;[name].dll.js&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    path</span><span class="token operator">:</span><span class="token plain"> path</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token plain">__dirname</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;dist&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    library</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;_dll_[name]&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// dll 的全局变量名</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  plugins</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">DllPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;_dll_[name]&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// dll 的全局变量名</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      path</span><span class="token operator">:</span><span class="token plain"> path</span><span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token plain">__dirname</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;dist&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;[name].manifest.json&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 描述生成的 manifest 文件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><p>需要注意 DllPlugin 的参数重 <code>name</code> 值必须和 <code>output.library</code> 保持一致，并且声称的 manifest 文件中会引用 <code>output.library</code> 值。</p><p>最终构建出的文件：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">|-- polyfill.dll.js</span></div><div class="token-line"><span class="token plain"> |-- polyfill.manifest.json</span></div><div class="token-line"><span class="token plain"> |-- react.dll.js</span></div><div class="token-line"><span class="token plain"> └── react.manifest.json</span></div></pre></div><p>其中 <code>xx.dll.js</code> 包含打包的 n 多模块，这些模块存在一个数组里，并以数组索引作为 ID，通过一个变量假设为 <code>__xx_dll</code> 暴露在全局中，可以通过 <code>window._xx_dll</code> 访问这些模块。<code>xx.manifest.json</code> 文件描述 <code>dll</code> 文件包含哪些模块、每个模块的路径和 ID。然后再在项目的主 config 文件里使用 DllReferencePlugin 插件引入 <code>xx.manifest.json</code> 文件。</p><ol start="2"><li>在主 config 文件里使用 DllPlugin 插件引入 <code>xx.manifest.json</code> 文件：</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// webpack.config.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> path </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;path&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">reports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  entry</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> main</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;./main.js&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  plugins</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">DllReferencePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      manifest</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./dist/react.manifest.json&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">DllReferencePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      manifest</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./dist/polyfill.manifest.json&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><p>最终构建声称 <code>main.js</code></p><h3 id="使用-happypack-开启多进程-loader-转换"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#使用-happypack-开启多进程-loader-转换"><span class="icon icon-link"></span></a>使用 HappyPack 开启多进程 Loader 转换</h3><p>在整个构建流程中，最耗时的就是 Loader 对文件的转换操作了，而运行在 NodeJS 之上的 Webpack 是单线程模型的，也就是只能一个一个文件进行处理，不能并行处理。HappyPack 可以将任务分解给多个子进程，最后将结果发给主进程。JS 是单线程模型，只能通过这种多进程的方式提高性能。</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function">npm</span><span class="token plain"> i happypack --save-dev</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> path </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;path&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">HappyPack</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;happypack&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  rules</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      test</span><span class="token operator">:</span><span class="token plain"> </span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">\.(js|jsx)$</span><span class="token regex regex-delimiter">/</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      include</span><span class="token operator">:</span><span class="token plain"> path</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token plain">__dirname</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;src&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 排除 node_modules 目录下的文件，node_modules 目录下的文件都采用了 ES5 语法，没必要再通过 Babel 去转换</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      exclude</span><span class="token operator">:</span><span class="token plain"> path</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token plain">__dirname</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;node_modules&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 将 JS 文件的处理转交给 id 为 babel 的 HappyPack 实例</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      use</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;happypacl/loader?id=babel&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      test</span><span class="token operator">:</span><span class="token plain"> </span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">\.css</span><span class="token regex regex-delimiter">/</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 将 CSS 文件的处理转交给 id 为 css 的 HappyPack 实例</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      use</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;happypack/loader?id=css&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  plugins</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">HappyPack</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 用唯一的标识符 id 来代表当前的 HappyPack 是用来处理一类特定的文件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      id</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;babel&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 如何处理该类文件，与 loader 配置一样</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      loaders</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;babel-loader?cacheDirectory&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">HappyPack</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      id</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;css&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      loaders</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;css-loader&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><p><strong>其他参数：</strong></p><ul><li>threads：代表开启几个子进程去处理这一类型的文件，默认是 3 个，必须是整数 。</li><li>verbose：是否允许 HappyPack 输出日志，默认是 true。</li><li>threadpool：代表共享进程池 ，即多个 HappyPack 实例都使用同一个共享进程池中的子进程去处理任务，以防止资源占用过多</li></ul><h3 id="使用-paralleluglifyplugin-开启多进程压缩-js-文件"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#使用-paralleluglifyplugin-开启多进程压缩-js-文件"><span class="icon icon-link"></span></a>使用 ParallelUglifyPlugin 开启多进程压缩 JS 文件</h3><p>使用 UglifyJS 插件压缩 JS 时，需要先将代码解析成 Object 表示的 AST（抽象语法树），再去应用各种规则去分析和处理 AST，所以这个过程计算量大耗时较多。ParallelUglifyPlugin 可以开启多个子进程，每个子进程使用 UglifyJS 压缩代码，可以并行执行，能显著缩短压缩时间。</p><p>使用也很简单，把原来的 UglifyJS 插件换成本插件即可。</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function">npm</span><span class="token plain"> i webpack-parallel-uglify-plugin --save-dev</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// webpack.config.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">ParallelUglifyPlugin</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;webpack-parallel-uglify-plugin&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">//...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    plugins</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 使用 ParallelUglifyPlugin 并行压缩输出的 JavaScript 代码</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">ParallelUglifyPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token comment">// 传递给 UglifyJS 的参数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            uglifyJS</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token comment">//...uglifyjs参数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                output</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    </span><span class="token comment">// 最紧凑的输出</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    beutify</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    </span><span class="token comment">// 删除所有注释</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    comments</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                compress</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    </span><span class="token comment">// 在 UglifyJS 删除没有用到的代码时不输出警告</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    warnings</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    </span><span class="token comment">// 删除所有 console 语句，可兼容 IE</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    drop_console</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    </span><span class="token comment">// 内嵌已定义但是只用到一次的变量</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    collapse_vars</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    </span><span class="token comment">// 提取出出现多次但是没有定义成变量去引用的静态值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    reduce_vars</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">//...其他ParallelUglifyPlugin的参数，设置cacheDir可以开启缓存，加快构建速度</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>ParallelUglifyPlugin 参数：</p><ul><li>test - 正则匹配需被压缩文件</li><li>include - 正则命中需被压缩文件 默认 <code>[]</code></li><li>exclude - 正则命中不需被压缩文件 默认 <code>[]</code></li><li>cacheDir - 缓存压缩后结果，下次遇到一样的输入时直接从缓存中获取压缩后的结果并返回。cacheDir 用于配置缓存存放的目录路径。默认不会缓存。</li><li>workcount - 子进程数量。默认计算机 CPU 核数减一</li><li>sourceMap - 是否输出 SourceMap</li><li>uglifyJS - 压缩 ES5 代码</li><li>uglifyES - 压缩 ES6 代码</li></ul><p>UglifyES 是 UglifyJS 的变种，专门用于压缩 ES6 代码。不能同时使用。</p><h2 id="优化开发体验"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#优化开发体验"><span class="icon icon-link"></span></a>优化开发体验</h2><p>通过自动化手段完成一些重复的工作，让我们专注于解决问题本身。</p><h3 id="使用自动刷新"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#使用自动刷新"><span class="icon icon-link"></span></a>使用自动刷新</h3><h4 id="文件监听"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#文件监听"><span class="icon icon-link"></span></a>文件监听</h4><p>Webpack 可以使用两种方式开启文件监听：</p><ul><li>启动 Webpack 时配置 <code>--watch</code> 参数</li><li>在配置文件中设置 <code>watch: true</code></li></ul><p>此外还有如下配置参数。合理设置 <code>watchOptions</code> 可以优化监听体验。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  watch</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  watchOptions</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 支持正则匹配</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 默认为空</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    ignored</span><span class="token operator">:</span><span class="token plain"> </span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">node_modules</span><span class="token regex regex-delimiter">/</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 文件变动后多久发起构建，越大越好</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    aggregateTimeout</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">300</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    poll</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 每秒询问次数，越小越好</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><ul><li><code>ignored</code>：设置不监听的文件目录，排除 <code>node_modules</code> 后可以显著减少 Webpack 消耗的内存</li><li><code>aggregateTimeout</code>：文件变动后多久发起构建，截流，避免文件更新太快而造成频繁编译以至卡死，越大越好</li><li><code>poll</code>：通过向系统轮询文件是否变化来判断文件是否改变，<code>poll</code> 为每秒询问次数，越小越好</li></ul><p><strong>文件监听的工作原理</strong></p><p>原理：定时获取文件的最后编辑时间，每次都存下最新的最后编辑时间，如果发现当前获取的和最后保存的不一致，就认为文件有变化。</p><p>当发现某个文件发生了变化时，并不会立刻告诉监昕者，而是先缓存起来，收集一段时间的变化后，再一次性告诉监听者。</p><p>确定监听文件列表：Webpack 会从 Entry 出发，递归解析出 Entry 文件所依赖的文件，将这些依赖的文件都加入监听列表中。</p><p>由于保存文件的路径和最后的编辑时间需要占用内存，定时检查周期检查需要占用 CPU 及文 件 110，所以最好减少需要监昕的文件数量和降低检查频率。</p><h4 id="devserver-刷新浏览器"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#devserver-刷新浏览器"><span class="icon icon-link"></span></a>DevServer 刷新浏览器</h4><p>DevServer 刷新浏览器有两种方式：</p><ol><li>向网页注入代理客户端代码，通过客户端发起刷新</li><li>向网页装入一个 iframe，通过刷新 iframe 实现刷新效果</li></ol><p>默认情况下，以及 <code>devserver: <!-- -->{<!-- -->inline: true<!-- -->}</code> 都是采用第一种方式刷新页面。第一种方式 DevServer 因为不知道网页依赖哪些 Chunk，所以会向每个 Chunk 中都注入客户端代码，当要输出很多 Chunk 时，会导致构建变慢。而一个页面只需要一个客户端，所以关闭 inline 模式可以减少构建时，Chunk 越多提升越明显。</p><p>关闭方式：</p><ol><li>启动时使用 <code>webpack-dev-server --inline false</code></li><li>配置 <code>devserver: <!-- -->{<!-- -->inline: false<!-- -->}</code></li></ol><p>关闭 inline 后入口网址变为 <code>http://localhost:8080/webpack-dev-server/</code></p><p>另外 <code>devServer.compress</code> 参数可配置是否采用 Gzip 压缩，默认为 false。</p><h3 id="开启模块热替换-hmr"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#开启模块热替换-hmr"><span class="icon icon-link"></span></a>开启模块热替换 HMR</h3><p>模块热替换不刷新整个网页而只重新编译发生变化的模块，并用新模块替换老模块，所以预览反应更快，等待时间更少，同时不刷新页面能保留当前网页的运行状态。原理也是向每一个 Chunk 中注入代理客户端来连接 DevServer 和网页，不同在于模块热替换的独特的模块替换机制。</p><p>优势：</p><ul><li>实时预览反应更快，等待时间更矩。</li><li>不刷新浏览器时能保留当前网页的运行状态，例如在使用 Redux 管理数据的 应用 中搭配模块热替换能做到在代码更新时 Redux 中的数据保持不变。</li></ul><p>开启方式：</p><ol><li><code>webpack-dev-server --hot</code></li><li>使用 HotModuleReplacementPlugin</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  entry</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 为每个入口都注入代理客户端</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    main</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token string">&#x27;webpack-dev-server/client?http://localhost:8080&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token string">&#x27;webpack/hot/dev-server&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token string">&#x27;./src/main.js&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  plugins</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// //该插件的作用就是实现模块热替换，实际上若启动时带上 --hot 参数，就会注入该插件，生成 .hot-update.json 文件。</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">webpack</span><span class="token class-name punctuation">.</span><span class="token class-name">HotModuleReplacement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  devServer</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 告诉 devServer 要开启模块热替换模式</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    hot</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><p>在启动 Webpack 时带上 <code>--hot</code> 参数，其实是自动完成以上配置。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token string">&quot;script&quot;</span><span class="token operator">:</span><span class="token plain"> webpack </span><span class="token operator">--</span><span class="token plain">hot</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>开启后如果修改子模块就可以实现局部刷新，但如果修改的是根 JS 文件，会整页刷新，原因在于，子模块更新时，事件一层层向上传递，直到某层的文件接收了当前变化的模块，然后执行回调函数。如果一层层向外抛知道最外层都没有文件接收，就会刷新整页。</p><p>使用 NamedModulePlugin 可以使控制台打印出被替换的模块的名称而非数学 ID，另外同 Webpack 监听，忽略 <code>node_modules</code> 目录的文件可以提升性能。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  plugins</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 显示出被替换模块的名称</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">webpack</span><span class="token class-name punctuation">.</span><span class="token class-name">NamedModulesPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><p>除此之外，模块热替换还面临和自动刷新一样的性能 问题，因为它们都需要监昕文件的变化和注入客户端。</p><h3 id="devtool"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#devtool"><span class="icon icon-link"></span></a>devtool</h3><p>使用 <code>devtool</code> 是很耗性能的，如果不需要用到它的话就不要设置它，如果需要用到且质量要很好可设为 <code>source-map</code>，不过这是非常耗时的，如果可以接受质量比较差的话，可使用 <code>cheap-source-map</code>，官方推荐使用的是性能比较好质量比较差的 <code>cheap-module-eval-source-map</code>。</p><ul><li>去除 sourmap</li></ul><h3 id="避免使用构建时才使用到的工具"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#避免使用构建时才使用到的工具"><span class="icon icon-link"></span></a>避免使用构建时才使用到的工具</h3><p>有一些工具在开发时是不需要用到的，如果用了可能会大大减慢生成代码的速度，如 UglifyJsPlugin，在开发时不需要将代码进行压缩，还有以下工具也避免在开发时用到：</p><ul><li>UglifyJsPlugin</li><li>ExtractTextPlugin</li><li>[hash]/[chunkhash]</li><li>AggressiveSplittingPlugin</li><li>AggressiveMergingPlugin</li><li>ModuleConcatenationPlugin</li></ul><h3 id="不要输出路径信息"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#不要输出路径信息"><span class="icon icon-link"></span></a>不要输出路径信息</h3><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  output</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    pathinfo</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><h3 id="关闭部分构建优化"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#关闭部分构建优化"><span class="icon icon-link"></span></a>关闭部分构建优化</h3><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token spread operator">...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  optimization</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    removeAvailableModules</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    removeEmptyChunks</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    splitChunks</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h2 id="优化输出质量---压缩文件体积"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#优化输出质量---压缩文件体积"><span class="icon icon-link"></span></a>优化输出质量 - 压缩文件体积</h2><h3 id="区分环境减少生产环境代码体积"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#区分环境减少生产环境代码体积"><span class="icon icon-link"></span></a>区分环境：减少生产环境代码体积</h3><p>代码运行环境分为开发环境和生产环境，代码需要根据不同环境做不同的操作，许多第三方库中也有大量的根据开发环境判断的 <code>if-else</code> 代码，构建也需要根据不同环境输出不同的代码，所以需要一套机制可以在源码中区分环境，区分环境之后可以使输出的生产环境的代码体积减少。Webpack 中使用 <a target="_blank" rel="noopener noreferrer" href="https://webpack.js.org/plugins/define-plugin/">webpack.DefinePlugin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 内置插件来定义配置文件适用的环境。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  plugins</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">webpack</span><span class="token class-name punctuation">.</span><span class="token class-name">DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token constant">PRODUCTION</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token constant">VERSION</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token string">&#x27;5fa3b9&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token constant">BROWSER_SUPPORTS_HTML5</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token constant">TWO</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;1+1&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token string">&#x27;typeof window&#x27;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token string">&#x27;object&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token string">&#x27;process.env.NODE_ENV&#x27;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token plain">process</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><p>⚠️ 注意，需要 JSON 序列化 <code>JSON.stringify(&#x27;production&#x27;)</code> 的原因是，环境变量值需要一个双引号包裹的字符串，而 stringify 后的值时 <code>&#x27;production&#x27;</code>。</p><p>然后就可以在源码中使用定义的环境：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">process</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;production&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;你在生产环境&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">doSth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;你在开发环境&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">doSthElse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>当代码中使用 <code>process</code> 时，Webpack 会自动打包进 <code>process</code> 模块的代码以支持非 Node.js 的运行环境，这个模块的作用时模拟 Node.js 中的 <code>process</code>，以支持 <code>process.env.NODE_ENV === &#x27;procution&#x27;</code> 语句。</p><h3 id="压缩代码jsescss"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#压缩代码jsescss"><span class="icon icon-link"></span></a>压缩代码：JS、ES、CSS</h3><h4 id="压缩-javascriptwebpack-内置-uglifyjs-插件paralleluglifyplugin"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#压缩-javascriptwebpack-内置-uglifyjs-插件paralleluglifyplugin"><span class="icon icon-link"></span></a>压缩 JavaScript：Webpack 内置 UglifyJS 插件、ParallelUglifyPlugin</h4><p>会分析 JavaScript 代码语法树，理解代码的含义，从而做到去除无效代码、去掉日志输出代码、缩短变量名等优化。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  plugins</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">webpack</span><span class="token class-name punctuation">.</span><span class="token class-name">UglifyJSPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      compress</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        warnings</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 删除无用代码时不输出警告</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        drop_console</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 删除所有console语句，可兼容IE</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        collapse_vars</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 内嵌已定义但只使用一次的变量</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        reduce_vars</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 提取使用多次但没定义的静态值到变量</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      output</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        beautify</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 最紧凑的输出，不保留空格和制表符</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        comments</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 删除所有注释</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><p>使用 <code>webpack --optimize-minimize</code> 启动 webpack，可以注入默认配置的 UglifyJSPlugin。</p><h4 id="压缩-es6第三方-uglifyjs-插件"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#压缩-es6第三方-uglifyjs-插件"><span class="icon icon-link"></span></a>压缩 ES6：第三方 UglifyJS 插件</h4><p>随着越来越多的浏览器支持直接执行 ES6 代码，应尽可能的运行原生 ES6，这样比起转换后的 ES5 代码，代码量更少，且 ES6 代码性能更好。直接运行 ES6 代码时，也需要代码压缩，第三方的 <code>uglify-webpack-plugin</code> 提供了压缩 ES6 代码的功能：</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function">npm</span><span class="token plain"> i uglify-webpack-plugin@beta --save-dev</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">UglifyESPlugin</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;uglify-webpack-plugin&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    plugins</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">UglifyESPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            uglifyOptions</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token comment">// 比UglifyJS多嵌套一层</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                compress：</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    warnings</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    drop_console</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    collapse_vars</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    reduce_vars</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                output</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    beautify</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    comments</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>另外要防止 babel-loader 转换 ES6 代码，要在 <code>.babelrc</code> 中去掉 babel-loader-env，因为正是 babel-preset-env 负责 ES6 转换为 ES5。</p><p>生产环境必备 压缩混淆代码 降低浏览加载资源体积 降低页面渲染时间 也防止反向编译工程的可能性</p><h4 id="压缩-csscss-loaderminimizepurifycssplugin"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#压缩-csscss-loaderminimizepurifycssplugin"><span class="icon icon-link"></span></a>压缩 CSS：css-loader?minimize、PurifyCSSPlugin</h4><p>cssnano 基于 PostCSS，不仅是删掉空格，还能理解代码含义，例如把 <code>color:#ff0000</code> 转换成 <code>color: red</code>，css-loader 内置了 cssnano，只需要使用 <code>css-loader?minimize</code> 就可以开启 cssnano 压缩。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> path </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;path&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token maybe-class-name">WebPlugin</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;web-webpack-plugin&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">ExtractTextPlugin</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;extract-text-webpack-plugin&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  module</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    rules</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        test</span><span class="token operator">:</span><span class="token plain"> </span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">\.css$</span><span class="token regex regex-delimiter">/</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 提取 Chunk 中的 CSS 代码到单独的文件中</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        use</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">ExtractTextPlugin</span><span class="token punctuation">.</span><span class="token method function property-access">extract</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token comment">// 通过 minimize 选项压缩 CSS 代码</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          use</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;css-loader?minimize&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  plugins</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 用 WebPlugin 生成对应的 HTML 文件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">WebPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      template</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;./template.html&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      filename</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;index.html&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">ExtractTextPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      filename</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;[name]_[contenthash:8].css&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><p>另外一种压缩 CSS 的方式是使用 PurifyCSSPlugin，需要配置 <code>extract-text-webpack-plugin</code> 使用，它主要的作用是可以去除没有用到的 CSS 代码，类似 JS 的 TreeShaking。</p><h3 id="使用-treeshaking-去除无效代码"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#使用-treeshaking-去除无效代码"><span class="icon icon-link"></span></a>使用 TreeShaking 去除无效代码</h3><p>TreeShaking 可以去除无用代码，它依赖于 ES6 的 <code>import</code>、<code>export</code> 的模块化语法，最先在 Rollup 中出现，Webpack2.0 开始引入使用。适合用于 <code>lodash</code>、<code>utils.js</code> 等工具类较分散的文件。</p><p>它正常工作的前提是代码必须采用 ES6 的模块化语法，因为 ES6 模块化语法是静态的（在导入、导出语句中的路径必须是静态字符串，且不能放入其他代码块中）。</p><p>如果采用了 ES5 中的模块化，例如 <code>module.export = <!-- -->{<!-- -->...<!-- -->}</code>、<code>require(x+y)</code>、<code>if(x)<!-- -->{<!-- -->require(&#x27;./util&#x27;)<!-- -->}</code>，则 Webpack 无法分析出可以去除哪些嗲吗。</p><p>在项目中使用大量第三方库时，我们会发现 TreeShaking 似乎不生效了，原因是大部分 NPM 中的代码都采用了 CommonJS 语法，这导致 TreeShaking 无法正常工作而降级处理。但幸运的是，有些库考虑到了这一点，这些库在发布到 NPM 上时会同时提供两份代码，一份采用 CommonJS 模块化语法，一份采用 ES6 模块化语法。并且在 package.json 文件中分别指出这两份代码的入口。</p><p>为了让 TreeShaking 有效，需要配置 Webpack 的文件寻找规则。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  resolve</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 针对 NPM 中的第三方模块优先采用 jsnext:main 中指向的 ES6 模块化语法的文件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    mainFields</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;jsnext:main&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;browser&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;main&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><p>虽然并不是每个 NPM 中的第三方模块都会提供 ES6 模块化语法的代码，但对于已提供了的代码要尽量优化。</p><p>采用 <code>jsnext:main</code> 作为 ES6 模块化代码的入口时社区的一个约定。</p><h3 id="公共代码提取"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#公共代码提取"><span class="icon icon-link"></span></a>公共代码提取</h3><p>CommonChunksPlugin =&gt; SplitChunksPlugin（webpack4+）</p><p>📌 方法一：分开 vendor 和 app（区分第三方代码和业务代码）不打包第三方代码 DLLPlugin DLLReferencePlugin 映射关系 打包业务代码映射 通过第三方库打包 不用打包第三方库 把打包第三方库的时间节省下来</p><ul><li>相同资源重复加载，浪费用户流量和服务器成本</li><li>每个页面需要加载的资源太大，导致网页首屏加载缓慢，影响用户体验</li></ul><p>提取策略：</p><ul><li>根据网站所使用的技术栈，找出网站的所有页面都需要用到的基础库，以采用 React 技术栈的网站为例，所有页面都会依赖 react、react-dom 等库，将它们提取到一个单独的文件 base.js 中，该文件包含了所有网页的基础运行环境。（为了长期缓存 base.js 文件）</li><li>在剔除了个页面中被 base.js 包含的部分代码后，再找出所有页面都依赖的公共部分代码，将它们提取出来并放到 common.js 中。</li><li>再为每个页面都生成一个单独的文件，而只包含各个页面单独需要的部分代码。</li></ul><h3 id="压缩和混淆"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#压缩和混淆"><span class="icon icon-link"></span></a>压缩和混淆</h3><p>UglifyJsPlugin 压缩和混淆</p><ul><li>删除多余的代码、注释、简化代码</li><li>平行处理</li><li>从向上下 处理很慢</li><li>parallel-webpack</li><li>cache 利用缓存</li></ul><h2 id="优化输出质量---加速网络请求"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#优化输出质量---加速网络请求"><span class="icon icon-link"></span></a>优化输出质量 - 加速网络请求</h2><h3 id="使用-cdn-加速静态资源加载"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#使用-cdn-加速静态资源加载"><span class="icon icon-link"></span></a>使用 CDN 加速静态资源加载</h3><p><strong>CDN 加速的原理</strong></p><p>CDN 通过资源部署到世界各地，使得用户可以就近访问资源，加快访问速度。要接入 CDN，需要把网页的静态资源上传到 CDN 服务上，在访问这些资源时，使用 CDN 服务提供的 URL。CDN 其实是通过优化物理链路层传输过程中的光速有限、丢包等问题来提升网速的。</p><p>由于 CDN 会为资源开启长时间的缓存，例如用户从 CDN 上获取了 <code>index.html</code>，即使之后替换了 CDN 上的 <code>index.html</code>，用户那边仍会在使用之前的版本直到缓存时间过期。业界做法：</p><ul><li><strong>HTML 文件：放在自己的服务器上且关闭服务器上的缓存，不接入 CDN</strong></li><li><strong>静态的 JS、CSS、图片等资源：开启 CDN 和缓存，同时文件名带上由内容计算出的 Hash 值</strong>，这样只要内容变化 hash 就会变化，文件名就会变化，就会被重新下载而不论缓存时间多长。</li></ul><p>另外，HTTP1.x 版本的协议下，浏览器会对于向同一域名并行发起的请求数限制在 4~8 个。那么把所有静态资源放在同一域名下的 CDN 服务上就会遇到这种限制，所以可以把他们分散放在不同的 CDN 服务上，例如 JS 文件放在 <code>js.cdn.com</code> 下，将 CSS 文件放在 <code>css.cdn.com</code> 下等。这样又会带来一个新的问题：增加了域名解析时间，这个可以通过 <strong>dns-prefetch</strong> 来解决 <code>&lt;link rel=&#x27;dns-prefetch&#x27; href=&#x27;//js.cdn.com&#x27;&gt;</code> 来缩减域名解析的时间。形如<code>//xx.com</code> 这样的 URL 省略了协议，这样做的好处是，浏览器在访问资源时会自动根据当前 URL 采用的模式来决定使用 HTTP 还是 HTTPS 协议。</p><p><strong>总之，构建需要满足以下几点：</strong></p><ul><li>静态资源导入的 URL 要变成指向 CDN 服务的绝对路径的 URL</li><li>静态资源的文件名需要带上根据内容计算出的 Hash 值</li><li>不同类型资源放在不同域名的 CDN 上</li></ul><p><strong>最终配置</strong></p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">ExtractTextPlugin</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;extract-text-webpack-plugin&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token maybe-class-name">WebPlugin</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;web-webpack-plugin&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  output</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    filename</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;[name]_[chunkhash:8].js&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    path</span><span class="token operator">:</span><span class="token plain"> path</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token plain">__dirname</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;dist&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    publicPath</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;//js.cdn.com/id/&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 指定CSS文件中导入的图片等资源存放的CDN地址</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  module</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    rules</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        test</span><span class="token operator">:</span><span class="token plain"> </span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">\.css</span><span class="token regex regex-delimiter">/</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        use</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">ExtractTextPlugin</span><span class="token punctuation">.</span><span class="token method function property-access">extract</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          use</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;css-loader?minimize&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          publicPath</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;//img.cdn.com/id/&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 指定CSS文件中导入的图片等资源存放的CDN地址</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        test</span><span class="token operator">:</span><span class="token plain"> </span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">\.png</span><span class="token regex regex-delimiter">/</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        use</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;file-loader?name=[name]_[hash:8].[ext]&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 为输出的PNG文件名加上Hash值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  plugins</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">WebPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      template</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;./template.html&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      filename</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;index.html&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      stylePublicPath</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;//css.cdn.com/id/&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">//指定存放CSS文件的CDN地址</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">ExtractTextPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      filename</span><span class="token operator">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">[name]_[contenthash:8].css</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">//为输出的CSS文件加上Hash</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><hr/><p>使用 <code>externals</code> 可以防止某些库被打包，而通过其他方式引用库（如 CDN），这样做的好处是当更新代码时不会影响库代码的缓存，用户只需下载新的代码即可。当然我们也可以使用 chunk 来把不常更新的库打包在另一个文件。</p><p>例如：从 CDN 引入 React</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token operator">&lt;</span><span class="token plain">script crossorigin src</span><span class="token operator">=</span><span class="token string">&quot;https://unpkg.com/react@16/umd/react.production.min.js&quot;</span><span class="token plain"> defer</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">script</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token operator">&lt;</span><span class="token plain">script crossorigin src</span><span class="token operator">=</span><span class="token string">&quot;https://unpkg.com/react-dom@16/umd/react-dom.production.min.js&quot;</span><span class="token plain"> defer</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">script</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token operator">&lt;</span><span class="token plain">script src</span><span class="token operator">=</span><span class="token string">&quot;./dist/index.js&quot;</span><span class="token plain"> defer</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">script</span><span class="token operator">&gt;</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  externals</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    react</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;React&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token string">&#x27;react-dom&#x27;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;ReactDOM&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><h3 id="多页面应用提取页面间公共代码"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#多页面应用提取页面间公共代码"><span class="icon icon-link"></span></a>多页面应用提取页面间公共代码</h3><p><strong>原理</strong></p><p>大型网站通常由多个页面组成，每个页面都是一个独立的单页应用，多个页面间肯定会依赖同样的样式文件、技术栈等。如果不把这些公共文件提取出来，那么每个单页打包出来的 chunk 中都会包含公共代码，相当于要传输 n 份重复代码。如果把公共文件提取出一个文件，那么当用户访问了一个网页，加载了这个公共文件，再访问其他依赖公共文件的网页时，就直接使用文件在浏览器的缓存，这样公共文件就只用被传输一次。</p><p><strong>应用方法</strong></p><ol><li>把多个页面依赖的公共代码提取到 <code>common.js</code> 中，此时 <code>common.js</code> 包含基础库的代码</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">//...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  plugins</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">webpack</span><span class="token class-name punctuation">.</span><span class="token class-name">CommonsChunkPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      chunks</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;a&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;b&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 从哪些chunk中提取</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;common&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 提取出的公共部分形成一个新的chunk</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><ol start="2"><li>找出依赖的基础库，写一个 <code>base.js</code> 文件，再与 <code>common.js</code> 提取公共代码到 <code>base</code> 中，<code>common.js</code> 就去除了基础库代码，而 <code>base.js</code> 保持不变。</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// base.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">import</span><span class="token plain"> </span><span class="token string">&#x27;react&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">import</span><span class="token plain"> </span><span class="token string">&#x27;react-dom&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">import</span><span class="token plain"> </span><span class="token string">&#x27;./base.css&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// webapck.config.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  entry</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    base</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;./base.js&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  plugins</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">CommonsChunkPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      chunks</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;base&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;common&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;base&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// minChunks: 2 表示文件要被提取出来需要在指定的chunks中出现的最小次数，防止common.js中没有代码的情况</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><ol start="3"><li>得到基础代码 <code>base.js</code>，不含基础库的公共代码 <code>common.js</code>，和页面个字的代码文件 <code>xx.js</code>。</li></ol><p>页面引用顺序如下：</p><p><code>base.js =&gt; common.js =&gt; xx.js</code></p><h3 id="分割代码以按需加载"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#分割代码以按需加载"><span class="icon icon-link"></span></a>分割代码以按需加载</h3><p><strong>原理</strong></p><p>单页应用的一个问题在于使用一个页面承载复杂的功能，要加载的文件体积很大，不进行优化的话会导致首屏加载时间过长，影响用户体验。做按需加载可以解决这个问题。具体方法如下：</p><p>将网站功能按照相关程度划分成几类</p><p>每一类合并成一个 Chunk，按需加载对应的 Chunk 例如，只把首屏相关的功能放入执行入口所在的 Chunk，这样首次加载少量的代码，其他代码要用到的时候再去加载。最好提前预估用户接下来的操作，提前加载对应代码，让用户感知不到网络加载</p><p><strong>实现方案</strong></p><p>一个最简单的例子：网页首次只加载 <code>main.js</code>，网页展示一个按钮，点击按钮时加载分割出去的 <code>show.js</code>，加载成功后执行 <code>show.js</code> 里的函数</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">//main.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">&#x27;btn&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#x27;click&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName:&quot;show&quot; */</span><span class="token plain"> </span><span class="token string">&#x27;./show&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">show</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">show</span><span class="token punctuation">(</span><span class="token string">&#x27;Webpack&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">//show.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">alert</span><span class="token punctuation">(</span><span class="token string">&#x27;Hello &#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> content</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><p><code>import(/* webpackChunkName:show */ &#x27;./show&#x27;).then()</code> 是实现按需加载的关键，Webpack 内置对 <code>import(*)</code> 语句的支持，Webpack 会以 <code>./show.js</code> 为入口重新生成一个 Chunk。代码在浏览器上运行时只有点击了按钮才会开始加载 <code>show.js</code>，且 import 语句会返回一个 Promise，加载成功后可以在 then 方法中获取加载的内容。这要求浏览器支持 Promise API，对于不支持的浏览器，需要注入 <code>Promise polyfill</code>。<code>/* webpackChunkName:show */</code> 是定义动态生成的 Chunk 的名称，默认名称是 <code>[id].js</code>，定义名称方便调试代码。为了正确输出这个配置的 ChunkName，还需要配置 Webpack：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">//...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">output</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    filename</span><span class="token operator">:</span><span class="token string">&#x27;[name].js&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    chunkFilename</span><span class="token operator">:</span><span class="token string">&#x27;[name].js&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">//指定动态生成的Chunk在输出时的文件名称</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h3 id="长缓存优化"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#长缓存优化"><span class="icon icon-link"></span></a>长缓存优化</h3><p><a target="_blank" rel="noopener noreferrer" href="https://sebastianblade.com/using-webpack-to-achieve-long-term-cache/#hash">https://sebastianblade.com/using-webpack-to-achieve-long-term-cache/#hash<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><p>long-time cache 也叫做 持久化缓存方案</p><p>什么是长缓存? 为什么需要长缓存? 怎么做?</p><p>开发过程，从 url 访问资源，服务器返回请求时，控制 http 协议，带版本号，告诉该资源是否需要重新向服务器请求新资源。</p><p>希望开发的过程中，如果代码有更新，版本号发生变化，说明这部分代码，不影响代码，如果被浏览器被缓存。</p><p>场景： 改变 app 代码，vendor 变化（不被 app 变化而改变版本号，因为只是改变业务代码） 解决： 提取 vendor hash（这次打包的 hash）=&gt;chunkhash（） 提取 webpack runtime</p><p>场景： 引入新模块，模块顺序变化，vendor.hash 变化 解决： NamedChunksPlugin NamedModulesPlugin</p><p>场景： 非静态引入，动态引入 vendor hash 变化 解决： 定义动态模块的 chunkname</p><p>总结： 独立打包 vendor 抽出 manifest（webpack runtime） 使用 NamedChunksPlugin 使用 NamedModulesPlugin 动态模块给定模块名称</p><p>hash 会在每次打包时变化 原因是 Webpack 使用自增的数字作为每一个模块的标识</p><p>HashedModuleIdsPlugin 使用模块路径作为 hash index 改变 =&gt; hash 变化 vendor 第三方库引用不变 =&gt; vendor 无限期使用缓存</p><p>根据第三方库使用的稳定性进一步拆分 stable-vendors 和 vendors</p><p>cssnano（css-loader?minimize）压缩 CSS</p><h2 id="优化输出质量---提升代码运行时效率"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#优化输出质量---提升代码运行时效率"><span class="icon icon-link"></span></a>优化输出质量 - 提升代码运行时效率</h2><h3 id="使用-prepack-提前求值"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#使用-prepack-提前求值"><span class="icon icon-link"></span></a>使用 Prepack 提前求值</h3><p><strong>原理</strong></p><p>Prepack 是一个部分求值器，编译代码时提前将计算结果放到编译后的代码中，而不是在代码运行时才去求值。通过在便一阶段预先执行源码来得到执行结果，再直接将运行结果输出以提升性能。但是现在 Prepack 还不够成熟，用于线上环境还为时过早。</p><p><strong>使用方法</strong></p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">PrepackWebpackPlugin</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;prepack-webpack-plugin&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword module">default</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  plugins</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">PrepackWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><h3 id="使用-scope-hoisting"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#使用-scope-hoisting"><span class="icon icon-link"></span></a>使用 Scope Hoisting</h3><p><strong>原理</strong></p><p>译作“作用域提升”，是在 Webpack3 中推出的功能，它分析模块间的依赖关系，尽可能将被打散的模块合并到一个函数中，但不能造成代码冗余，所以只有被引用一次的模块才能被合并。由于需要分析模块间的依赖关系，所以源码必须是采用了<strong>ES6 模块化</strong>的，否则 Webpack 会降级处理不采用 Scope Hoisting。</p><p><strong>使用方法</strong></p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">ModuleConcatenationPlugin</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;webpack/lib/optimize/ModuleConcatenationPlugin&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">//...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    plugins</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">ModuleConcatenationPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    resolve</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        mainFields</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&#x27;jsnext:main&#x27;</span><span class="token punctuation">,</span><span class="token string">&#x27;browser&#x27;</span><span class="token punctuation">,</span><span class="token string">&#x27;main&#x27;</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h2 id="使用输出分析工具"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#使用输出分析工具"><span class="icon icon-link"></span></a>使用输出分析工具</h2><p>启动 Webpack 时带上这两个参数可以声称一个 JSON 文件，输出分析工具大多依赖该文件进行分析：</p><p><code>webpack --profile --json &gt; stats.json</code> 其中 <code>--profile</code> 记录构建过程中的耗时信息，<code>--json</code> 以 JSON 的格式输出构建结果，<code>&gt;stats.json</code> 是 UNIX / Linux 系统中的管道命令，含义是将内容通过管道输出到 <code>stats.json</code> 文件中。</p><h3 id="官方工具-webpackanalyse"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#官方工具-webpackanalyse"><span class="icon icon-link"></span></a>官方工具 WebpackAnalyse</h3><p>打开该工具的官网 <a target="_blank" rel="noopener noreferrer" href="http://webpack.github.io/analyse/">http://webpack.github.io/analyse/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 上传 stats.json，就可以得到分析结果</p><h3 id="webpack-bundle-analyzer"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#webpack-bundle-analyzer"><span class="icon icon-link"></span></a>webpack-bundle-analyzer</h3><p>可视化分析工具，比 Webpack Analyzer 更直观。</p><ol><li><code>npm i webpack-bundle-analyzer</code> 安装插件</li><li>按照上面方法声称 stats.json 文件</li><li>在项目根目录执行 <code>webpack-bundle-analyzer</code> 浏览器会自动打开结果分析页面</li></ol><h2 id="补充说明"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#补充说明"><span class="icon icon-link"></span></a>补充说明</h2><ul><li><p>配置 <code>babel-loader</code> 时，<code>use: [‘babel-loader?cacheDirectory’]</code> cacheDirectory 用于缓存 babel 的编译结果，加快重新编译的速度。另外注意排除 node_modules 文件夹，因为文件都使用了 ES5 的语法，没必要再使用 Babel 转换。</p></li><li><p>配置 <code>externals</code>，排除因为已使用 <code>&lt;script&gt;</code> 标签引入而不用打包的代码，noParse 是排除没使用模块化语句的代码。</p></li><li><p>配置 <code>performance</code> 参数可以输出文件的性能检查配置。</p></li><li><p>配置 <code>profile：true</code>，是否捕捉 Webpack 构建的性能信息，用于分析是什么原因导致构建性能不佳。</p></li><li><p>配置 <code>cache：true</code>，是否启用缓存来提升构建速度。</p></li><li><p>可以使用 <code>url-loader</code> 把小图片转换成 base64 嵌入到 JavaScript 或 CSS 中，减少加载次数。</p></li><li><p>通过 <code>imagemin-webpack-plugin</code> 压缩图片，通过 <code>webpack-spritesmith</code> 制作雪碧图。</p></li><li><p>开发环境下将 devtool 设置为 <code>cheap-module-eval-source-map</code>，因为生成这种 source map 的速度最快，能加速构建。在生产环境下将 devtool 设置为 <code>hidden-source-map</code></p></li></ul><h3 id="babel"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#babel"><span class="icon icon-link"></span></a>Babel</h3><p>📌 babel-loader 十分耗时间 options.cacheDirectory 开启缓存 indclude 规定范围 exclude 排除范围 减少工作量</p><p><a target="_blank" rel="noopener noreferrer" href="mailto:babel@7.0">babel@7.0<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 因为现在大多数浏览器都已经支持 ES6 语法，所以如果所有代码都转为 ES5 的话可能产生大量的多余代码，所以这里只转换部分代码，那么兼容低版本的浏览器怎么办。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// .babelrc</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token string">&quot;presets&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token string">&quot;@babel/react&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token string">&quot;modules&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"> </span><span class="token comment">// 关闭 babel 的模块转换，才能使用 Webpack 的 tree-shaking 功能</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token string">&quot;plugins&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;@babel/plugin-proposal-class-properties&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// class 这个要放在前面 否则可能报错</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;@babel/plugin-transform-classes&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// class</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;@babel/plugin-transform-arrow-functions&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 箭头函数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;@babel/plugin-transform-template-literals&quot;</span><span class="token plain"> </span><span class="token comment">// 字符串模版</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>当一些库的 <code>package.json</code> 的 <code>sideEffects</code> 有设置时，就可以很好地支持 Tree-Shaking。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;lodash&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token string">&quot;sideEffects&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h2 id="其他方法"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#其他方法"><span class="icon icon-link"></span></a>其他方法</h2><ul><li>减少 resolve</li><li>devtool 去除 sourcemap</li><li>cache-loader</li><li>升级 node</li><li>升级 webpack</li></ul><p>能并行处理就并行处理 uglify happy-pack 减少 webpack 打包任务 第三方和业务分离 减少消耗编译时间的 babel 或 uglifyjs babel 只处理 src 限定范围 尽可能使用缓存 跟进版本</p><p>利用 CDN 加速。在构建过程中，将引用的静态资源路径修改为 CDN 上对应的路径，可以利用 webpack 对于 output 参数和各 loader 的 publicPath 参数来修改资源路径</p><p>TreeShaking 将代码永远不会运行到的片段删除 可以再在启动 Webpack 时追加参数 <code>--optimize-minimize</code> 实现</p><p><strong>把代码构建到 ES6+</strong></p><p>上面说到转换代码到 ES5 的话会很耗时且可能有很多多余代码，因为现在大多数浏览器都已经支持 ES6 语法，现在我们来看看如何兼容较低版本的浏览器。</p><p>module、nomodule:</p><p>可以使用 <code>&lt;script type=&quot;module&quot; src=&quot;index.js&quot;&gt;&lt;/script&gt;</code> 来加载 ES6+ 的代码，因为支持这个属性的浏览器必定会支持 <code>async/await</code>、<code>Promise</code>、<code>class</code> 这些属性，而不支持的浏览器则会选择忽略它，不进行加载。 所以也还需要一份 ES5 的脚本来兼容低版本的浏览器，使用 <code>&lt;script nomodule src=&quot;index.es5.js&quot;&gt;&lt;/script&gt;</code> 来加载 ES5 代码，可以识别 <code>nomodule</code> 的浏览器会忽略它，而不能识别它的低版本浏览器则会加载它。这样就可以做到兼容到低版本的浏览器而较新的浏览器使用代码量少很多的 ES6+代码。 但是这个方法也有缺点：当使用 <code>splitChunks</code> 把代码分为较多的模块时，需要产生大量两个版本的代码。</p><p><strong>动态 polyfill</strong></p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token operator">&lt;</span><span class="token plain">script src</span><span class="token operator">=</span><span class="token string">&quot;https://cdn.polyfill.io/v2/polyfill.min.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">script</span><span class="token operator">&gt;</span></div></pre></div><p>它会通过分析请求头信息中的 UserAgent 实现自动加载浏览器所需的 polyfills。如果你使用较新的版本访问上面的连接会发现没有多少代码，而用 IE 则会产生很多。这样我们就可以使用 ES6+ 的代码和动态 polyfill 来兼容低版本浏览器，但是动态 polyfill 不能支持 <code>class</code> 和箭头函数等等这些特性，所以就需要按上面那样配置 babel 来把这些转换成 ES5 的。想知道更多动态 polyfill 可以点这里。</p><p><strong>进阶方案对比</strong></p><table><thead><tr><th></th><th>适用于生产</th><th>首次编译快</th><th>二次编译快</th><th>整体尺寸不变大</th><th>支持拆包到文件级别</th><th>是否为通用方案</th><th>Webpack 高级功能</th></tr></thead><tbody><tr><td>dll</td><td>X</td><td>X</td><td>Y</td><td>X</td><td>X</td><td>Y</td><td>Y</td></tr><tr><td>external</td><td>X</td><td>Y</td><td>Y</td><td>X</td><td>X</td><td>Y</td><td>Y</td></tr><tr><td>物理缓存</td><td>X</td><td>X</td><td>Y</td><td>Y</td><td>Y</td><td>Y</td><td>Y</td></tr><tr><td>ModuleFederation</td><td>Y</td><td>Y</td><td>Y</td><td>Y</td><td>Y</td><td>看方案和社区发展</td><td>Y</td></tr><tr><td>systemjs</td><td>加载会变慢</td><td>编译快，但加载慢</td><td>Y</td><td>Y</td><td>Y</td><td>Y</td><td>X</td></tr><tr><td>ESM in Browser</td><td>加载会变慢</td><td>编译快，但加载慢</td><td>Y</td><td>Y</td><td>Y</td><td>Y</td><td>X</td></tr><tr><td>Pika + Snowpack</td><td>加载会变慢</td><td>Y</td><td>Y</td><td>X</td><td>Y</td><td>Y</td><td>X</td></tr><tr><td>Gravity</td><td>加载会变慢</td><td>编译快，但加载慢</td><td>Y</td><td>Y</td><td>Y</td><td>Y</td><td>X</td></tr></tbody></table><h2 id="参考文章"><a aria-hidden="true" tabindex="-1" href="/webpack-guidebook//best-practice/optimization/collection#参考文章"><span class="icon icon-link"></span></a>参考文章</h2><ul><li><a target="_blank" rel="noopener noreferrer" href="https://juejin.im/post/5b652b036fb9a04fa01d616b#heading-13">📝 三十分钟掌握 Webpack 性能优化<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://juejin.im/post/5cceecb7e51d453ab908717c">📝 Webpack 优化总会让你不得不爱<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/sisterAn/blog/issues/63">Webpack 系列二：优化 90%打包速度<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/Webpack-Guidebook/edit/master/docs/best-practice/optimization/collection.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last update: ">10/27/2021 18:51:11</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/webpack-guidebook/umi.a58570f0.js"></script>
  </body>
</html>
