<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/webpack-guidebook/umi.css" />
    <script>
      window.routerBase = "/webpack-guidebook/";
    </script>
    <script>
      //! umi version: 3.2.20
    </script>
    <title>模块热更新</title>
  
</head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/webpack-guidebook-favicon.svg&#x27;)" href="/webpack-guidebook//">Webpack Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a href="/webpack-guidebook//basic-summary">基本综述</a><a aria-current="page" class="active" href="/webpack-guidebook//principle-analysis">原理分析</a><a href="/webpack-guidebook//best-practice">最佳实践</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/webpack-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/webpack-guidebook-favicon.svg&#x27;)" href="/webpack-guidebook//"></a><h1>Webpack Guidebook</h1><p>Webpack 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/webpack-guidebook//basic-summary">基本综述</a></li><li><a aria-current="page" class="active" href="/webpack-guidebook//principle-analysis">原理分析</a></li><li><a href="/webpack-guidebook//best-practice">最佳实践</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/webpack-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a href="/webpack-guidebook//principle-analysis/babel">Babel</a></li><li><a aria-current="page" class="active" href="/webpack-guidebook//principle-analysis/operational-principle">工作原理</a><ul><li><a href="/webpack-guidebook//principle-analysis/operational-principle/file-watch"><span>文件监听</span></a></li><li><a aria-current="page" class="active" href="/webpack-guidebook//principle-analysis/operational-principle/hot-module-replacement"><span>模块热更新</span></a></li><li><a href="/webpack-guidebook//principle-analysis/operational-principle/filenames-hashes"><span>文件指纹策略</span></a></li><li><a href="/webpack-guidebook//principle-analysis/operational-principle/tree-shaking"><span>Tree Shaking</span></a></li><li><a href="/webpack-guidebook//principle-analysis/operational-principle/scope-hoisting"><span>作用域提升</span></a></li><li><a href="/webpack-guidebook//principle-analysis/operational-principle/sourcemap"><span>SourceMap</span></a></li></ul></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle">底层原理</a><ul><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/workflow"><span>构建流程</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/simple-implementation"><span>简易实现</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/source-code-analysis"><span>源码分析</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/tapable"><span>Tapable</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/compiler"><span>Compiler</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/compilation"><span>Compilation</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/loader"><span>Loader 机制</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/plugin"><span>Plugin 机制</span></a></li><li><a href="/webpack-guidebook//principle-analysis/implementation-principle/ast"><span>抽象语法树</span></a></li></ul></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"><li title="编译构建过程" data-depth="2" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/hot-module-replacement#编译构建过程"><span>编译构建过程</span></a></li><li title="实现流程" data-depth="2" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/hot-module-replacement#实现流程"><span>实现流程</span></a></li><li title="源码实现" data-depth="2" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/hot-module-replacement#源码实现"><span>源码实现</span></a></li><li title="启动本地开发服务" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/hot-module-replacement#启动本地开发服务"><span>启动本地开发服务</span></a></li><li title="修改构建配置" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/hot-module-replacement#修改构建配置"><span>修改构建配置</span></a></li><li title="监听构建编译完成" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/hot-module-replacement#监听构建编译完成"><span>监听构建编译完成</span></a></li><li title="监听文件变化" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/hot-module-replacement#监听文件变化"><span>监听文件变化</span></a></li><li title="通知浏览器文件变更" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/hot-module-replacement#通知浏览器文件变更"><span>通知浏览器文件变更</span></a></li><li title="热更新插件" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/hot-module-replacement#热更新插件"><span>热更新插件</span></a></li><li title="启动热更新" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/hot-module-replacement#启动热更新"><span>启动热更新</span></a></li><li title="热更新模块替换" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/hot-module-replacement#热更新模块替换"><span>热更新模块替换</span></a></li><li title="热更新总结" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/hot-module-replacement#热更新总结"><span>热更新总结</span></a></li><li title="相关文件解析" data-depth="2" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/hot-module-replacement#相关文件解析"><span>相关文件解析</span></a></li><li title="webpack-dev-server（WDS）" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/hot-module-replacement#webpack-dev-server（wds）"><span>webpack-dev-server（WDS）</span></a></li><li title="webpack-dev-middleware" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/hot-module-replacement#webpack-dev-middleware"><span>webpack-dev-middleware</span></a></li><li title="hot-module-replacement-plugin" data-depth="3" class=""><a href="/webpack-guidebook//principle-analysis/operational-principle/hot-module-replacement#hot-module-replacement-plugin"><span>hot-module-replacement-plugin</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="模块热更新"><a aria-hidden="true" href="#模块热更新"><span class="icon icon-link"></span></a>模块热更新</h1><blockquote><p><code>Hot Module Replacement</code>（模块热更新），简称 <code>HMR</code>，是指在应用程序运行过程中，替换、添加或删除模块，而无需重新加载整个页面。主要通过以下几种方式，来显著加快开发速度：</p><ul><li>保留在完全重新加载页面期间丢失的应用程序状态</li><li>只更新变更内容，以节省宝贵的开发时间</li><li>在源代码中对 CSS / JS 进行修改，会立刻在浏览器中进行更新，这几乎相当于在浏览器 devtools 直接更改样式</li></ul></blockquote><p>而页面的刷新我们一般分为两种：</p><ul><li>一种是页面刷新，<strong>不保留页面状态</strong>，就是简单粗暴，直接 <code>window.location.reload()</code></li><li>另一种是基于 WDS (webpack-dev-server) 的模块热替换，只需要<strong>局部刷新页面上发生变化的模块，同时可以保留当前的页面状态</strong>，比如复选框的选中状态、输入框的输入等</li></ul><p>相对于 Live Reload 刷新页面的方案，HMR 的优点在于可以保存应用的状态，提高了开发效率。</p><h2 id="编译构建过程"><a aria-hidden="true" href="#编译构建过程"><span class="icon icon-link"></span></a>编译构建过程</h2><p>下面我们通过一次打包构建了解编译构建的过程和需要关注的点。</p><p>项目启动后，进行构建打包，控制台会输出构建过程，我们可以观察到生成了一个 Hash 值：<code>a93fd735d02d98633356</code>。</p><p><img src="/webpack-guidebook/static/hmr-bundle-new-hash.47d5ab2a.jpg"/></p><p>然后，在我们每次修改代码保存后，控制台都会出现 <code>Compiling...</code> 字样，触发新的编译，可以在控制台中观察到：</p><ul><li>新的 Hash 值：<code>a61bdd6e82294ed06fa3</code></li><li>新的 JSON 文件： <code>a93fd735d02d98633356.hot-update.json</code></li><li>新的 JS 文件：<code>index.a93fd735d02d98633356.hot-update.js</code></li></ul><p><img src="/webpack-guidebook/static/hmr-bundle-update-hash.f01eab24.jpg"/></p><p>首先，我们知道 Hash 值代表每一次编译的标识。</p><p>其次，根据新生成文件名可以发现，上次输出的 Hash 值会作为本次编译新生成的文件标识。依次类推，本次输出的 Hash 值会被作为下次热更新的标识。</p><p>然后看一下，新生成的文件是什么？每次修改代码，紧接着触发重新编译，然后浏览器就会发出 2 次请求。请求的便是本次新生成的 2 个文件。如下：</p><p><img src="/webpack-guidebook/static/hmr-browser-hash-message.15563f83.jpg"/></p><p>首先看 JSON 文件，返回的结果中：</p><ul><li><code>h</code> 表示本次新生成的 Hash 值，用于下次文件热更新请求的前缀</li><li><code>c</code> 表示当前要热更新的文件对应的是 <code>index</code> 模块</li></ul><p>再看下生成的 JS 文件，那就是本次修改的代码，重新编译打包后的。</p><p><img src="/webpack-guidebook/static/hmr-browser-file-message.05707d93.jpg"/></p><p>还有一种情况是，如果没有任何代码改动，直接保存文件，控制台也会输出编译打包信息的。</p><ul><li>新的 Hash 值：<code>d2e4208eca62aa1c5389</code></li><li>新的 JSON 文件：<code>a61bdd6e82294ed06fa3.hot-update.json</code></li></ul><p><img src="/webpack-guidebook/static/hmr-code-unchanged-bundle-message.ce74a36b.jpg"/></p><p>但是我们发现，并没有生成新的 JS 文件，因为没有改动任何代码，同时浏览器发出的请求，可以看到 <code>c</code> 值为空，代表本次没有需要更新的代码。</p><p><img src="/webpack-guidebook/static/hmr-code-unchanged-browser-message.441ccfbb.jpg"/></p><h2 id="实现流程"><a aria-hidden="true" href="#实现流程"><span class="icon icon-link"></span></a>实现流程</h2></div><img alt="热更新流程图" src="/webpack-guidebook/static/webpack-hmr-workflow.0cb3a06e.jpg" width="720"/><div class="markdown"><ul><li>橙色框是浏览器端</li><li>红色框是服务端</li><li>绿色方框是 Webpack 代码控制的区域</li><li>蓝色方框是 webpack-dev-server 代码控制的区域</li><li>桃红色方框是文件系统，文件修改后的变化就发生在这</li><li>靛蓝色方框是应用本身</li></ul><p>上图显示了我们修改代码到模块热更新完成的一个周期，通过深绿色的阿拉伯数字符号已经将 HMR 的整个过程标识了出来。</p><ol><li><p>第一步，在 webpack 的 watch 模式下，文件系统中某一个文件发生修改，webpack 监听（<a href="/webpack-guidebook//principle-analysis/operational-principle/file-watch">文件监听的实现原理</a>）到文件变化，根据配置文件对模块 <strong>重新编译打包</strong>，并将打包后的代码通过简单的 JavaScript 对象保存在 <strong style="color:red">内存</strong> 中。</p></li><li><p>第二步是 <strong>webpack</strong> 和 <strong>webpack-dev-server</strong> 之间的接口交互，而在这一步，主要是 webpack-dev-server 的中间件 webpack-dev-middleware 和 webpack 之间的交互，webpack-dev-middleware 调用 webpack 暴露的 API 对代码变化进行监控，并且告诉 webpack，将代码打包到内存中。</p></li><li><p>第三步是 webpack-dev-server 对文件变化的一个监控，这一步不同于第一步，并不是监控代码变化重新打包。当我们在配置文件中配置了<a href="https://webpack.js.org/configuration/dev-server/#devserver-watchcontentbase" target="_blank" rel="noopener noreferrer">devServer.watchContentBase<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 为 <code>true</code> 的时候，Server 会监听这些配置文件夹中静态文件的变化，变化后会通知浏览器端对应用进行 live reload。注意，这儿是<strong>浏览器刷新</strong>，和 HMR 是两个概念。</p></li><li><p>第四步也是 webpack-dev-server 代码的工作，该步骤主要是通过 <a href="https://github.com/sockjs/sockjs-client" target="_blank" rel="noopener noreferrer">sockjs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（webpack-dev-server 的依赖）在浏览器端和服务端之间建立一个 <strong>websocket 长连接</strong>，将 webpack 编译打包的<strong>各个阶段的状态信息</strong>告知浏览器端，同时也包括第三步中 web-dev-server 监听静态文件变化的信息。浏览器端根据这些 socket 消息进行不同的操作。当然服务端传递的最主要信息还是 <strong style="color:red">新模块的 Hash 值</strong>，后面的步骤根据这一 Hash 值来进行模块热替换。</p></li><li><p>webpack-dev-server / client 端并不能够请求更新的代码，也不会执行热更模块操作，而把这些工作又交回给了 webpack，webpack / hot / dev-server 的工作就是根据 webpack-dev-server / client 传给它的信息以及 webpack-dev-server 的配置决定是<strong>刷新浏览器</strong>呢还是进行<strong>模块热更新</strong>。当然如果仅仅是刷新浏览器，也就没有后面那些步骤了。</p></li><li><p>HotModuleReplacement.runtime 是客户端 HMR 的中枢，它接收到上一步传递给他的新模块的 Hash 值，它通过 JsonpMainTemplate.runtime 向 server 端发送 AJAX 请求，服务端返回一个 JSON，该 JSON 包含了所有要更新的模块的 Hash 值，获取到更新列表后，该模块再次通过 JSONP 请求，获取到最新的模块代码。这就是上图中 7、8、9 步骤。</p></li><li><p>而第 10 步是决定 HMR 成功与否的关键步骤，在该步骤中，HotModulePlugin 将会对 <strong style="color:red">新旧模块进行对比</strong>，决定是否更新模块，在决定更新模块后，检查模块之间的依赖关系，更新模块的同时更新模块间的依赖引用。</p></li><li><p>最后一步，当 HMR 失败后，回退到 live reload 操作，也就是进行浏览器刷新来获取最新打包代码。</p></li></ol><h2 id="源码实现"><a aria-hidden="true" href="#源码实现"><span class="icon icon-link"></span></a>源码实现</h2></div><img alt="源码实现流程" src="/webpack-guidebook/static/hmr-source-workflow.65e5f646.jpg" width="800"/><div class="markdown"><h3 id="启动本地开发服务"><a aria-hidden="true" href="#启动本地开发服务"><span class="icon icon-link"></span></a>启动本地开发服务</h3><p>我们根据 webpack-dev-server 的 <code>package.json</code> 中的 <code>bin</code> 命令，可以找到命令的入口文件 <code>bin/webpack-dev-server.js</code>。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// node_modules/webpack-dev-server/bin/webpack-dev-server.js

// 生成 webpack 编译主引擎 compiler
let compiler = webpack(config);

// 启动本地服务
let server = new Server(compiler, options, log);
server.listen(options.port, options.host, err =&gt; {
  if (err) {
    throw err;
  }
});
" data-status="copy"></button><div class="token-line"><span class="token comment">// node_modules/webpack-dev-server/bin/webpack-dev-server.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 生成 webpack 编译主引擎 compiler</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> compiler </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">webpack</span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 启动本地服务</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> server </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Server</span><span class="token punctuation">(</span><span class="token plain">compiler</span><span class="token punctuation">,</span><span class="token plain"> options</span><span class="token punctuation">,</span><span class="token plain"> log</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">server</span><span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token plain">options</span><span class="token punctuation">.</span><span class="token property-access">port</span><span class="token punctuation">,</span><span class="token plain"> options</span><span class="token punctuation">.</span><span class="token property-access">host</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token parameter">err</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">throw</span><span class="token plain"> err</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>本地服务代码：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// node_modules/webpack-dev-server/lib/Server.js
class Server {
    constructor() {
        this.setupApp();
        this.createServer();
    }

    setupApp() {
        // 依赖了 Express
        this.app = new express();
    }

    // 启动静态资源服务
    createServer() {
        this.listeningApp = http.createServer(this.app);
    }

    listen(port, hostname, fn) {
        return this.listeningApp.listen(port, hostname, (err) =&gt; {
            // 启动 Express 服务后，启动 WebSocket 服务，与浏览器端建立连接
            this.createSocketServer();
        }
    }
}
" data-status="copy"></button><div class="token-line"><span class="token comment">// node_modules/webpack-dev-server/lib/Server.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Server</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">setupApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">setupApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 依赖了 Express</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">app</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 启动静态资源服务</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">listeningApp</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> http</span><span class="token punctuation">.</span><span class="token method function property-access">createServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">app</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter">port</span><span class="token parameter punctuation">,</span><span class="token parameter"> hostname</span><span class="token parameter punctuation">,</span><span class="token parameter"> fn</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">listeningApp</span><span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token plain">port</span><span class="token punctuation">,</span><span class="token plain"> hostname</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token comment">// 启动 Express 服务后，启动 WebSocket 服务，与浏览器端建立连接</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">createSocketServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>这一小节代码主要做了三件事：</p><ul><li>启动 Webpack，生成 <code>compiler</code> 实例。<code>compiler</code> 上有很多方法，比如可以启动 Webpack 所有编译工作，以及监听本地文件的变化。</li><li>使用 Express 框架启动本地 Server，让浏览器可以请求本地的静态资源。</li><li>本地 Server 启动之后，再去启动 WebSocket 服务。通过 WebSocket，可以建立本地服务和浏览器的双向通信。当本地文件发生变化时，服务器会立马告知浏览器热更新代码。</li></ul><p>上述代码主要干了三件事，但是源码在启动服务前又做了很多事，接下来便看看 <code>webpack-dev-server/lib/Server.js</code> 还做了哪些事？</p><h3 id="修改构建配置"><a aria-hidden="true" href="#修改构建配置"><span class="icon icon-link"></span></a>修改构建配置</h3><p>启动本地服务前，调用了 <code>updateCompiler(this.compiler)</code> 方法。这个方法中有两段关键性代码。一个是<strong>获取 WebSocket 客户端代码路径</strong>，另一个是<strong>根据配置获取 Webpack 热更新代码路径</strong>。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// 获取 WebSocket 客户端代码
const clientEntry = `${require.resolve(
  &#x27;../../client/&#x27;
)}?${domain}${sockHost}${sockPath}${sockPort}`;

// 根据配置获取热更新代码
let hotEntry;
if (options.hotOnly) {
  hotEntry = require.resolve(&#x27;webpack/hot/only-dev-server&#x27;);
} else if (options.hot) {
  hotEntry = require.resolve(&#x27;webpack/hot/dev-server&#x27;);
}
" data-status="copy"></button><div class="token-line"><span class="token comment">// 获取 WebSocket 客户端代码</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> clientEntry </span><span class="token operator">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string">`</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">require</span><span class="token template-string interpolation punctuation">.</span><span class="token template-string interpolation function">resolve</span><span class="token template-string interpolation punctuation">(</span><span class="token template-string interpolation"></span></div><div class="token-line"><span class="token template-string interpolation">  </span><span class="token template-string interpolation string">&#x27;../../client/&#x27;</span><span class="token template-string interpolation"></span></div><div class="token-line"><span class="token template-string interpolation"></span><span class="token template-string interpolation punctuation">)</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">?</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">domain</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">sockHost</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">sockPath</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">sockPort</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 根据配置获取热更新代码</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> hotEntry</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">options</span><span class="token punctuation">.</span><span class="token property-access">hotOnly</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  hotEntry </span><span class="token operator">=</span><span class="token plain"> require</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token string">&#x27;webpack/hot/only-dev-server&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">options</span><span class="token punctuation">.</span><span class="token property-access">hot</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  hotEntry </span><span class="token operator">=</span><span class="token plain"> require</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token string">&#x27;webpack/hot/dev-server&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>修改后的 Webpack 入口配置如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// 修改后的entry入口
{
  entry:
    {
      index:
        [
          // 上面获取的 clientEntry
          &#x27;xxx/node_modules/webpack-dev-server/client/index.js?http://localhost:8080&#x27;,
          // 上面获取的 hotEntry
          &#x27;xxx/node_modules/webpack/hot/dev-server.js&#x27;,
          // 开发配置的入口
          &#x27;./src/index.js&#x27;
        ],
    },
}
" data-status="copy"></button><div class="token-line"><span class="token comment">// 修改后的entry入口</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  entry</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      index</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token comment">// 上面获取的 clientEntry</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token string">&#x27;xxx/node_modules/webpack-dev-server/client/index.js?http://localhost:8080&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token comment">// 上面获取的 hotEntry</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token string">&#x27;xxx/node_modules/webpack/hot/dev-server.js&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token comment">// 开发配置的入口</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token string">&#x27;./src/index.js&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>为什么要新增了 2 个文件？在入口默默增加了 2 个文件，那就意味会一同打包到 <code>bundle</code> 文件中去，也就是<strong>线上运行时</strong>。</p><p><strong>webpack-dev-server/client/index.js</strong></p><p>首先这个文件用于 WebSocket 通信的，我们在第 1 步 webpack-dev-server 初始化的过程中，启动的是本地服务端的 Websocket。因此我们需要把 WebSocket 客户端通信代码与我们的代码打包在一起。</p><p><strong>webpack/hot/dev-server.js</strong></p><p>这个文件主要是用于检查更新逻辑的，这里大家知道就好，代码后面会在合适的时机（第 5 步）细讲。</p><h3 id="监听构建编译完成"><a aria-hidden="true" href="#监听构建编译完成"><span class="icon icon-link"></span></a>监听构建编译完成</h3><p>修改好入口配置后，又调用了 <code>setupHooks</code> 方法。这个方法是用来注册监听事件的，监听<strong>每次 Webpack 编译完成</strong>。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// node_modules/webpack-dev-server/lib/Server.js

// 绑定监听事件
setupHooks() {
    const {done} = compiler.hooks;
    // 监听 Webpack 的 done 钩子，tapable 提供的监听方法
    done.tap(&#x27;webpack-dev-server&#x27;, (stats) =&gt; {
        this._sendStats(this.sockets, this.getStats(stats));
        this._stats = stats;
    });
};
" data-status="copy"></button><div class="token-line"><span class="token comment">// node_modules/webpack-dev-server/lib/Server.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 绑定监听事件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">setupHooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">done</span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> compiler</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 监听 Webpack 的 done 钩子，tapable 提供的监听方法</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    done</span><span class="token punctuation">.</span><span class="token method function property-access">tap</span><span class="token punctuation">(</span><span class="token string">&#x27;webpack-dev-server&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_sendStats</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">sockets</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">getStats</span><span class="token punctuation">(</span><span class="token plain">stats</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_stats</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> stats</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>当 Webpack 每次编译结束，就会调用 <code>_sendStats</code> 方法（webpack-dev-server 监听了 compiler 的 <code>done</code> 事件）通过 WebSocket 给浏览器发送通知（把重新编译打包后的新模块 Hash 值发送给浏览器端），进而触发 <code>ok</code> 和 <code>hash</code> 事件，这样浏览器就可以拿到最新的 Hash 值了，做检查更新逻辑。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// 通过websoket给客户端发消息
_sendStats() {
    this.sockWrite(sockets, &#x27;hash&#x27;, stats.hash);
    this.sockWrite(sockets, &#x27;ok&#x27;);
}
" data-status="copy"></button><div class="token-line"><span class="token comment">// 通过websoket给客户端发消息</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">_sendStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">sockWrite</span><span class="token punctuation">(</span><span class="token plain">sockets</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;hash&#x27;</span><span class="token punctuation">,</span><span class="token plain"> stats</span><span class="token punctuation">.</span><span class="token property-access">hash</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">sockWrite</span><span class="token punctuation">(</span><span class="token plain">sockets</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;ok&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="监听文件变化"><a aria-hidden="true" href="#监听文件变化"><span class="icon icon-link"></span></a>监听文件变化</h3><p>Webpack 对文件系统进行 <code>watch</code> 监听打包到内存中。</p><p>webpack-dev-middleware 调用 Webpack 的 API 对文件系统 watch，当代码文件发生改变后，Webpack 监听到文件发生变化后自动出发重新对文件的编译打包，然后保存到内存中。</p><p>很多人分不清 webpack-dev-middleware 和 webpack-dev-server 的区别。</p><ul><li><strong>webpack-dev-server</strong>：只负责启动服务和前置准备工作</li><li><strong>webpack-dev-middleware</strong>：所有文件相关的操作都抽离至此，主要是本地文件的编译和输出以及监听</li></ul><p>这样处理的目的是使得职的划分更加清晰。</p><p>那我们来看下 webpack-dev-middleware 源码里做了什么事:</p><p><a href="https://github.com/webpack/webpack-dev-middleware/blob/955e53e1b5/index.js#L48" target="_blank" rel="noopener noreferrer">源码位置<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// node_modules/webpack-dev-middleware/index.js
// start watching
if (!options.lazy) {
  const watching = compiler.watch(options.watchOptions, err =&gt; {
    if (err) {
      /* 错误处理，代码精简省略 */
    }
  });

  context.watching = watching;
} else {
  context.state = true;
}

// 通过 memory-fs 库将打包后的文件写入内存
setFs(context, compiler);
" data-status="copy"></button><div class="token-line"><span class="token comment">// node_modules/webpack-dev-middleware/index.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// start watching</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">options</span><span class="token punctuation">.</span><span class="token property-access">lazy</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> watching </span><span class="token operator">=</span><span class="token plain"> compiler</span><span class="token punctuation">.</span><span class="token method function property-access">watch</span><span class="token punctuation">(</span><span class="token plain">options</span><span class="token punctuation">.</span><span class="token property-access">watchOptions</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token parameter">err</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">/* 错误处理，代码精简省略 */</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  context</span><span class="token punctuation">.</span><span class="token property-access">watching</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> watching</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  context</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 通过 memory-fs 库将打包后的文件写入内存</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">setFs</span><span class="token punctuation">(</span><span class="token plain">context</span><span class="token punctuation">,</span><span class="token plain"> compiler</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ol><li>调用了 <code>compiler.watch</code> 方法，这个方法主要就做了 2 件事：</li></ol><ul><li>首先对本地文件代码进行编译打包，也就是 Webpack 的一系列编译流程</li><li>其次编译结束后，开启对本地文件的监听，当文件发生变化，重新编译，编译完成之后继续监听</li></ul><p>为什么代码的改动保存会自动编译，重新打包？这一系列的重新检测编译就归功于 <code>compiler.watch</code> 这个方法了。监听本地文件的变化主要是通过 <strong style="color:red">文件的生成时间</strong> 是否有变化。</p><ol start="2"><li>执行 <code>setFs</code> 方法，这个方法主要目的就是 <strong style="color:red">将编译后的文件打包到内存</strong>。这就是为什么在开发的过程中，你会发现 <code>dist</code> 目录没有打包后的代码文件。原因就在于访问内存中的代码比访问文件系统中的文件更快，而且也减少了代码写入文件的开销，这一切都归功于 <a href="https://github.com/webpack/memory-fs" target="_blank" rel="noopener noreferrer">memory-fs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（目前已使用 <a href="https://github.com/streamich/memfs" target="_blank" rel="noopener noreferrer">memfs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 代替）。</li></ol><h3 id="通知浏览器文件变更"><a aria-hidden="true" href="#通知浏览器文件变更"><span class="icon icon-link"></span></a>通知浏览器文件变更</h3><p>我们已经可以监听到文件的变化了，当文件发生变化，就触发重新编译。同时还监听了每次编译结束的事件。</p><p>当监听到一次 Webpack 编译结束，<code>_sendStats</code> 方法就通过 WebSoket 给浏览器发送通知，检查下是否需要热更新。下面重点讲的就是 <code>_sendStats</code> 方法中的 <code>ok</code> 和 <code>hash</code> 事件都做了什么。</p><p>那浏览器是如何接收到 WebSocket 的消息呢？回忆下第 2 步骤增加的入口文件，也就是 WebSocket 客户端代码。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="&#x27;xxx/node_modules/webpack-dev-server/client/index.js?http://localhost:8080&#x27;;
" data-status="copy"></button><div class="token-line"><span class="token string">&#x27;xxx/node_modules/webpack-dev-server/client/index.js?http://localhost:8080&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>这个文件的代码会被打包到 <code>bundle.js</code> 中，运行在浏览器中。来看下这个文件的核心代码吧。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// webpack-dev-server/client/index.js
var socket = require(&#x27;./socket&#x27;);
var onSocketMessage = {
  hash: function hash(_hash) {
    // 更新currentHash值
    status.currentHash = _hash;
  },
  ok: function ok() {
    sendMessage(&#x27;Ok&#x27;);
    // 进行更新检查等操作
    reloadApp(options, status);
  },
};
// 连接服务地址 socketUrl，?http://localhost:8080，本地服务地址
socket(socketUrl, onSocketMessage);

function reloadApp() {
  if (hot) {
    log.info(&#x27;[WDS] App hot update...&#x27;);

    // hotEmitter 其实就是 EventEmitter 的实例
    var hotEmitter = require(&#x27;webpack/hot/emitter&#x27;);
    hotEmitter.emit(&#x27;webpackHotUpdate&#x27;, currentHash);
  }
}
" data-status="copy"></button><div class="token-line"><span class="token comment">// webpack-dev-server/client/index.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> socket </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./socket&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> onSocketMessage </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function-variable function">hash</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token parameter">_hash</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 更新currentHash值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    status</span><span class="token punctuation">.</span><span class="token property-access">currentHash</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> _hash</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function-variable function">ok</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token string">&#x27;Ok&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 进行更新检查等操作</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">reloadApp</span><span class="token punctuation">(</span><span class="token plain">options</span><span class="token punctuation">,</span><span class="token plain"> status</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 连接服务地址 socketUrl，?http://localhost:8080，本地服务地址</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token plain">socketUrl</span><span class="token punctuation">,</span><span class="token plain"> onSocketMessage</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">reloadApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">hot</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    log</span><span class="token punctuation">.</span><span class="token method function property-access">info</span><span class="token punctuation">(</span><span class="token string">&#x27;[WDS] App hot update...&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// hotEmitter 其实就是 EventEmitter 的实例</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">var</span><span class="token plain"> hotEmitter </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;webpack/hot/emitter&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    hotEmitter</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;webpackHotUpdate&#x27;</span><span class="token punctuation">,</span><span class="token plain"> currentHash</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p><code>socket</code> 方法建立了 WebSocket 和服务端的连接，并注册了 2 个监听事件。</p><ul><li><code>hash</code> 事件：更新最新一次打包后的 Hash 值</li><li><code>ok</code> 事件：对应用进行热更新检查（会根据 <code>hot</code> 配置决定是 <strong>刷新浏览器</strong> 还是对代码进行 <strong>热更新（HMR）</strong>）</li></ul><p>热更新检查事件是调用 <a href="https://github.com/webpack/webpack-dev-server/blob/75718b7e25a27da598340cb00e23628d9496cd1a/client-src/default/utils/reloadApp.js" target="_blank" rel="noopener noreferrer">reloadApp<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 方法。比较奇怪的是，这个方法又利用 Node.js 的 EventEmitter，发出 <code>webpackHotUpdate</code> 消息。这是为什么？为什么不直接进行检查更新呢？</p><p>个人理解就是为了更好的维护代码，以及职责划分的更明确。WebSocket 仅仅用于客户端（浏览器）和服务端进行通信。而真正做事情的活还是交回给了 Webpack。</p><p>那 Webpack 怎么做的呢？再来回忆下第 2 步。入口文件还有一个文件没有讲到，就是：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="&#x27;xxx/node_modules/webpack/hot/dev-server.js&#x27;;
" data-status="copy"></button><div class="token-line"><span class="token string">&#x27;xxx/node_modules/webpack/hot/dev-server.js&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>这个文件的代码同样会被打包到 <code>bundle.js</code> 中，运行在浏览器中。这个文件做了什么就显而易见了吧！</p><p>先瞄一眼代码：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// node_modules/webpack/hot/dev-server.js
var check = function check() {
  module.hot
    .check(true)
    .then(function(updatedModules) {
      // 容错，直接刷新页面
      if (!updatedModules) {
        window.location.reload();
        return;
      }

      // 热更新结束，打印信息
      if (upToDate()) {
        log(&#x27;info&#x27;, &#x27;[HMR] App is up to date.&#x27;);
      }
    })
    .catch(function(err) {
      window.location.reload();
    });
};

var hotEmitter = require(&#x27;./emitter&#x27;);
hotEmitter.on(&#x27;webpackHotUpdate&#x27;, function(currentHash) {
  lastHash = currentHash;
  check();
});
" data-status="copy"></button><div class="token-line"><span class="token comment">// node_modules/webpack/hot/dev-server.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> </span><span class="token function-variable function">check</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  module</span><span class="token punctuation">.</span><span class="token property-access">hot</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">.</span><span class="token method function property-access">check</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">updatedModules</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 容错，直接刷新页面</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">updatedModules</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">location</span><span class="token punctuation">.</span><span class="token method function property-access">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 热更新结束，打印信息</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function">upToDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;info&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;[HMR] App is up to date.&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">.</span><span class="token method function property-access">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">location</span><span class="token punctuation">.</span><span class="token method function property-access">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> hotEmitter </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./emitter&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">hotEmitter</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;webpackHotUpdate&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">currentHash</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  lastHash </span><span class="token operator">=</span><span class="token plain"> currentHash</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>结合上面代码，首先将 Hash 值暂存到 <code>currentHash</code> 变量，当接收到 <code>ok</code> 消息后，对应用程序进行 <code>reload</code>。如果配置了模块热更新，就调用 webpack/hot/emitter 将最新 Hash 值发送给 webpack，然后将控制权交给 Webpack 客户端代码（就是浏览器端代码）。如果没有配置模块热更新，就直接调用 <code>location.reload</code> 方法刷新页面。</p><p>这里 Webpack 监听到了 <code>webpackHotUpdate</code> 事件，并获取最新了最新的 Hash 值，然后终于进行检查更新了。检查更新调用的是 <code>module.hot.check</code> 方法。那么问题又来了，<code>module.hot.check</code> 又是哪里冒出来了的！答案是 HotModuleReplacementPlugin 搞得鬼。这里留个疑问，继续往下看。</p><h3 id="热更新插件"><a aria-hidden="true" href="#热更新插件"><span class="icon icon-link"></span></a>热更新插件</h3><p>热更新有最核心的是 HMR Server 和 HMR runtime。</p><ul><li>HMR Server 是服务端，用来将变化的 JS 模块通过 WebSocket 的消息通知给浏览器端。</li><li>HMR Runtime 是浏览器端，用于接受 HMR Server 传递的模块数据，浏览器端可以看到 <code>.hot-update.JSON</code> 的文件过来。</li></ul><p>前面好像一直是 webpack-dev-server 做的事，那 HotModuleReplacementPlugin 在热更新过程中又干了什么呢？</p><p>首先你可以对比下，配置热更新和不配置时 <code>bundle.js</code> 的区别。</p><p>内存中看不到？直接执行 Webpack 命令就可以看到生成的 <code>bundle.js</code> 文件啦。不要用 webpack-dev-server 启动就好了。</p><p><strong>没有配置热更新</strong></p><p><img src="/webpack-guidebook/static/hmr-no-config.83acf849.jpg"/></p><p><strong>配置热更新</strong></p><p><img src="/webpack-guidebook/static/hmr-config.23881cbf.jpg"/></p><p>我们发现 <code>moudle</code> 新增了一个属性为 <code>hot</code>，再看 <code>hotCreateModule</code> 方法。 这不就找到 <code>module.hot.check</code> 是哪里冒出来的。</p><p><img src="/webpack-guidebook/static/hmr-hot-create-module.5e68cf2c.jpg"/></p><p>经过对比打包后的文件，<code>__webpack_require__</code> 中的 <code>moudle</code> 以及代码行数的不同。我们都可以发现 HotModuleReplacementPlugin 原来也是默默的塞了很多代码到 <code>bundle.js</code> 中。</p><p>你也可以直接看浏览器 Sources 下的代码，会发现 Webpack 和 plugin 偷偷加的代码都在哦。在这里调试也很方便。</p><p><img src="/webpack-guidebook/static/hmr-source-code.3ede8105.jpg"/></p><p>HotModuleReplacementPlugin 如何做到的？这里我就不讲了，因为这需要你对 tapable 以及 plugin 机制有一定了解，可以看下 <a href="https://juejin.im/post/5dc169b0f265da4d542092c6" target="_blank" rel="noopener noreferrer">Webpack 插件机制之 Tapable-源码解析<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><h3 id="启动热更新"><a aria-hidden="true" href="#启动热更新"><span class="icon icon-link"></span></a>启动热更新</h3><p>通过第 6 步，我们就可以知道 <code>moudle.hot.check</code> 方法是如何来的啦。那都做了什么？之后的源码都是 HotModuleReplacementPlugin 塞入到 <code>bundle.js</code> 中。</p><ul><li>利用上次保存的 Hash 值，调用 <code>hotDownloadManifest</code> 发送 <code>xxx/hash.hot-update.json</code> 的 AJAX 请求；</li><li>请求结果获取热更新模块，以及下次热更新的 Hash 标识，并进入热更新准备阶段。</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// 需要更新的文件
hotAvailableFilesMap = update.c;

// 更新下次热更新 Hash 值
hotUpdateNewHash = update.h;

// 进入热更新准备状态
hotSetStatus(&#x27;prepare&#x27;);
" data-status="copy"></button><div class="token-line"><span class="token comment">// 需要更新的文件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">hotAvailableFilesMap </span><span class="token operator">=</span><span class="token plain"> update</span><span class="token punctuation">.</span><span class="token property-access">c</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 更新下次热更新 Hash 值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">hotUpdateNewHash </span><span class="token operator">=</span><span class="token plain"> update</span><span class="token punctuation">.</span><span class="token property-access">h</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 进入热更新准备状态</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">hotSetStatus</span><span class="token punctuation">(</span><span class="token string">&#x27;prepare&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>调用 <code>hotDownloadUpdateChunk</code> 发送 <code>xxx/hash.hot-update.js</code> 请求，通过 JSONP 方式。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="function hotDownloadUpdateChunk(chunkId) {
  var script = document.createElement(&#x27;script&#x27;);
  script.charset = &#x27;utf-8&#x27;;
  script.src = __webpack_require__.p + &#x27;&#x27; + chunkId + &#x27;.&#x27; + hotCurrentHash + &#x27;.hot-update.js&#x27;;
  if (null) script.crossOrigin = null;
  document.head.appendChild(script);
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">hotDownloadUpdateChunk</span><span class="token punctuation">(</span><span class="token parameter">chunkId</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> script </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token string">&#x27;script&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  script</span><span class="token punctuation">.</span><span class="token property-access">charset</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;utf-8&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  script</span><span class="token punctuation">.</span><span class="token property-access">src</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> __webpack_require__</span><span class="token punctuation">.</span><span class="token property-access">p</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token string">&#x27;&#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> chunkId </span><span class="token operator">+</span><span class="token plain"> </span><span class="token string">&#x27;.&#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> hotCurrentHash </span><span class="token operator">+</span><span class="token plain"> </span><span class="token string">&#x27;.hot-update.js&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> script</span><span class="token punctuation">.</span><span class="token property-access">crossOrigin</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">head</span><span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span><span class="token plain">script</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>hotDownloadUpdateChunk 方法返回的就是最新 hash 值对应的代码块，然后将新的代码块返回给 HMR runtime，进行模块热更新</p><p>这个函数体为什么要单独拿出来，因为这里要解释下为什么使用 JSONP 获取最新代码？主要是因为 JSONP 获取的代码可以直接执行。为什么要直接执行？我们来回忆下 <code>/hash.hot-update.js</code> 的代码格式是怎么样的。</p><p><img src="/webpack-guidebook/static/hmr-hash-hot-update.05707d93.jpg"/></p><p>可以发现，新编译后的代码是在一个 <code>webpackHotUpdate</code> 函数体内部的。也就是要立即执行 <code>webpackHotUpdate</code> 这个方法。</p><p>再看下 <code>webpackHotUpdate</code> 这个方法。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="window[&#x27;webpackHotUpdate&#x27;] = function(chunkId, moreModules) {
  hotAddUpdateChunk(chunkId, moreModules);
};
" data-status="copy"></button><div class="token-line"><span class="token dom variable">window</span><span class="token punctuation">[</span><span class="token string">&#x27;webpackHotUpdate&#x27;</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">chunkId</span><span class="token parameter punctuation">,</span><span class="token parameter"> moreModules</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">hotAddUpdateChunk</span><span class="token punctuation">(</span><span class="token plain">chunkId</span><span class="token punctuation">,</span><span class="token plain"> moreModules</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><code>hotAddUpdateChunk</code> 方法会把更新的模块 <code>moreModules</code> 赋值给全局全量 <code>hotUpdate</code></li><li><code>hotUpdateDownloaded</code> 方法会调用 <code>hotApply</code> 进行代码的替换。</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="function hotAddUpdateChunk(chunkId, moreModules) {
  // 更新的模块 moreModules 赋值给全局全量 hotUpdate
  for (var moduleId in moreModules) {
    if (Object.prototype.hasOwnProperty.call(moreModules, moduleId)) {
      hotUpdate[moduleId] = moreModules[moduleId];
    }
  }
  // 调用 hotApply 进行模块的替换
  hotUpdateDownloaded();
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">hotAddUpdateChunk</span><span class="token punctuation">(</span><span class="token parameter">chunkId</span><span class="token parameter punctuation">,</span><span class="token parameter"> moreModules</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 更新的模块 moreModules 赋值给全局全量 hotUpdate</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">var</span><span class="token plain"> moduleId </span><span class="token keyword">in</span><span class="token plain"> moreModules</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method function property-access">hasOwnProperty</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token plain">moreModules</span><span class="token punctuation">,</span><span class="token plain"> moduleId</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      hotUpdate</span><span class="token punctuation">[</span><span class="token plain">moduleId</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> moreModules</span><span class="token punctuation">[</span><span class="token plain">moduleId</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 调用 hotApply 进行模块的替换</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">hotUpdateDownloaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>为什么更新模块的代码不通过 webpack-dev-server 通过 WebSocket 发送到浏览器端，而是通过 JSONP 呢？</p><p>我的理解是，功能块的解耦，各个模块各司其职，dev-server/client 只负责消息的传递而不负责新模块的获取，而这些工作应该有 HMR runtime 来完成，HMR runtime 才应该是获取新代码的地方。再就是因为不使用 webpack-dev-server 的前提，使用 webpack-hot-middleware 和 Webpack 配合也可以完成模块热更新流程，在使用 webpack-hot-middleware 中有件有意思的事，它没有使用 WebSocket，而是使用的 EventSource。综上所述，HMR 的工作流中，不应该把新模块代码放在 WebSocket 消息中。</p><h3 id="热更新模块替换"><a aria-hidden="true" href="#热更新模块替换"><span class="icon icon-link"></span></a>热更新模块替换</h3><p>这步是整个模块热更新（HMR）的关键步骤，而且模块热更新都是发生在 HMR runtime 中的 <code>hotApply</code> 方法中。</p><p>模块热替换主要分三个阶段：</p><ol><li>找出 outdatedModules 和 outdatedDependencies，并从缓存中删除过期的模块和依赖</li><li>添加新的模块到 <code>modules</code> 中</li><li>当下次调用 <code>__webpack_require__</code>（Webpack 重写的 <code>require</code> 方法）方法的时候，就是获取到了新的模块代码了</li></ol><h4 id="删除过期的模块"><a aria-hidden="true" href="#删除过期的模块"><span class="icon icon-link"></span></a>删除过期的模块</h4><p>通过 <code>hotUpdate</code> 可以找到旧模块。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="var queue = outdatedModules.slice();
while (queue.length &gt; 0) {
  moduleId = queue.pop();
  // 从缓存中删除过期的模块
  module = installedModules[moduleId];
  // 删除过期的依赖
  delete outdatedDependencies[moduleId];

  // 存储了被删掉的模块id，便于更新代码
  outdatedSelfAcceptedModules.push({
    module: moduleId,
  });
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">var</span><span class="token plain"> queue </span><span class="token operator">=</span><span class="token plain"> outdatedModules</span><span class="token punctuation">.</span><span class="token method function property-access">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">queue</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  moduleId </span><span class="token operator">=</span><span class="token plain"> queue</span><span class="token punctuation">.</span><span class="token method function property-access">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 从缓存中删除过期的模块</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  module </span><span class="token operator">=</span><span class="token plain"> installedModules</span><span class="token punctuation">[</span><span class="token plain">moduleId</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 删除过期的依赖</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">delete</span><span class="token plain"> outdatedDependencies</span><span class="token punctuation">[</span><span class="token plain">moduleId</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 存储了被删掉的模块id，便于更新代码</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  outdatedSelfAcceptedModules</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    module</span><span class="token punctuation">:</span><span class="token plain"> moduleId</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h4 id="添加新增模块"><a aria-hidden="true" href="#添加新增模块"><span class="icon icon-link"></span></a>添加新增模块</h4><p>将新的模块添加到 <code>modules</code> 中。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="appliedUpdate[moduleId] = hotUpdate[moduleId];
for (moduleId in appliedUpdate) {
  if (Object.prototype.hasOwnProperty.call(appliedUpdate, moduleId)) {
    modules[moduleId] = appliedUpdate[moduleId];
  }
}
" data-status="copy"></button><div class="token-line"><span class="token plain">appliedUpdate</span><span class="token punctuation">[</span><span class="token plain">moduleId</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> hotUpdate</span><span class="token punctuation">[</span><span class="token plain">moduleId</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">moduleId </span><span class="token keyword">in</span><span class="token plain"> appliedUpdate</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method function property-access">hasOwnProperty</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token plain">appliedUpdate</span><span class="token punctuation">,</span><span class="token plain"> moduleId</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    modules</span><span class="token punctuation">[</span><span class="token plain">moduleId</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> appliedUpdate</span><span class="token punctuation">[</span><span class="token plain">moduleId</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h4 id="执行相关模块代码"><a aria-hidden="true" href="#执行相关模块代码"><span class="icon icon-link"></span></a>执行相关模块代码</h4><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="for (i = 0; i &lt; outdatedSelfAcceptedModules.length; i++) {
  var item = outdatedSelfAcceptedModules[i];
  moduleId = item.module;
  try {
    // 执行最新的代码
    __webpack_require__(moduleId);
  } catch (err) {
    // ...容错处理
  }
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">i </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">&lt;</span><span class="token plain"> outdatedSelfAcceptedModules</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> item </span><span class="token operator">=</span><span class="token plain"> outdatedSelfAcceptedModules</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  moduleId </span><span class="token operator">=</span><span class="token plain"> item</span><span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 执行最新的代码</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token plain">moduleId</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// ...容错处理</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h4 id="模块热更新的错误处理"><a aria-hidden="true" href="#模块热更新的错误处理"><span class="icon icon-link"></span></a>模块热更新的错误处理</h4><p>模块热更新的错误处理，如果在热更新过程中出现错误，热更新将回退到刷新浏览器，这部分代码在 dev-server 代码中，简要代码如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="module.hot
  .check(true)
  .then(function(updatedModules) {
    if (!updatedModules) {
      return window.location.reload();
    }
    // ...
  })
  .catch(function(err) {
    var status = module.hot.status();
    if ([&#x27;abort&#x27;, &#x27;fail&#x27;].indexOf(status) &gt;= 0) {
      window.location.reload();
    }
  });
" data-status="copy"></button><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">hot</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">.</span><span class="token method function property-access">check</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">updatedModules</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">updatedModules</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">location</span><span class="token punctuation">.</span><span class="token method function property-access">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">.</span><span class="token method function property-access">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">var</span><span class="token plain"> status </span><span class="token operator">=</span><span class="token plain"> module</span><span class="token punctuation">.</span><span class="token property-access">hot</span><span class="token punctuation">.</span><span class="token method function property-access">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;abort&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;fail&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">indexOf</span><span class="token punctuation">(</span><span class="token plain">status</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">&gt;=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">location</span><span class="token punctuation">.</span><span class="token method function property-access">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p><code>dev-server</code> 先验证是否有更新，没有代码更新的话，重载浏览器。如果在 <code>hotApply</code> 的过程中出现 <code>abort</code> 或者 <code>fail</code> 错误，也进行重载浏览器。</p><h3 id="热更新总结"><a aria-hidden="true" href="#热更新总结"><span class="icon icon-link"></span></a>热更新总结</h3><p>至此页面已经完成热更新，Webpack 如何实现热更新的呢？首先是建立起浏览器端和服务器端之间的通信，浏览器会接收服务器端推送的消息，如果需要热更新，浏览器发起 HTTP 请求去服务器端获取打包好的资源解析并局部刷新页面。</p><h2 id="相关文件解析"><a aria-hidden="true" href="#相关文件解析"><span class="icon icon-link"></span></a>相关文件解析</h2><ul><li>Webpack Compile：将 JS 编译成 Bundle</li><li>HMR Server：将热更新的文件输出给 HMR Runtime</li><li>Bundle Server：提供文件在浏览器的访问</li><li>HMR Runtime：会被注入到浏览器，更新文件的变化</li><li>bundle.js 构建输出的文件</li></ul><h3 id="webpack-dev-server（wds）"><a aria-hidden="true" href="#webpack-dev-server（wds）"><span class="icon icon-link"></span></a>webpack-dev-server（WDS）</h3><p>webpack-dev-server（WDS）的功能提供 bundle server 的能力，就是生成的 <code>bundle.js</code> 文件可以通过 <code>localhost://xxx</code> 的方式去访问，另外 WDS 也提供 livereload（浏览器的自动刷新）。</p><ul><li>可以不刷新浏览器，打包构建不出文件，而是放在内存中</li><li>使用 HotModuleReplacementPlugin 插件</li></ul><h3 id="webpack-dev-middleware"><a aria-hidden="true" href="#webpack-dev-middleware"><span class="icon icon-link"></span></a>webpack-dev-middleware</h3><p>WDM 将 wepback 输出的文件传输给服务器</p><p>适用于灵活的定制场景</p><blockquote><p>面试题：webpack-dev-server 和 webpack-dev-middleware 的详细区别，特别是使用场景</p></blockquote><h3 id="hot-module-replacement-plugin"><a aria-hidden="true" href="#hot-module-replacement-plugin"><span class="icon icon-link"></span></a>hot-module-replacement-plugin</h3><p>hot-module-replacement-plugin 的作用是提供 HMR 的 runtime，并且将 runtime 注入到 <code>bundle.js</code> 代码里面去。一旦磁盘里面的文件修改，那么 HMR server 会将有修改的 JS Module 信息发送给 HMR runtime，然后 HMR runtime 去局部更新页面的代码。<strong>因此这种方式可以不用刷新浏览器。</strong></p><p>webpack-dev-server 和 hot-module-replacement-plugin 之间的关系：hot-module-replacement-plugin 包给 webpack-dev-server 提供了热更新的能力。</p><p><strong>HotModuleReplacementPlugin 是做什么用的？</strong></p><p>Webpack 构建出来的 <code>bundle.js</code> 本身是不具备热更新的能力的，HotModuleReplacementPlugin 的作用就是将 HMR runtime 注入到 <code>bundle.js</code>，使得 <code>bundle.js</code> 可以和 HMR server 建立 WebSocket 的通信连接</p><hr/><p><strong>参考资料：</strong></p><ul><li><a href="https://github.com/webpack/webpack/blob/master/hot/dev-server.js" target="_blank" rel="noopener noreferrer">🗃 webpack / hot / dev-server<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://github.com/webpack/webpack-dev-server" target="_blank" rel="noopener noreferrer">🗃 webpack-dev-server<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://github.com/webpack-contrib/webpack-hot-middleware" target="_blank" rel="noopener noreferrer">🗃 webpack-hot-middleware<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://juejin.im/post/5df36ffd518825124d6c1765" target="_blank" rel="noopener noreferrer">📝 从零实现 Webpack 热更新 HMR（2019-12-14）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://juejin.im/post/5de0cfe46fb9a071665d3df0" target="_blank" rel="noopener noreferrer">📝 轻松理解 Webpack 热更新原理（2019-12-01）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://juejin.im/post/5d8b755fe51d45781332e919" target="_blank" rel="noopener noreferrer">📝 看完这篇，面试再也不怕被问 Webpack 热更新（2019-09-26）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://zhuanlan.zhihu.com/p/30669007" target="_blank" rel="noopener noreferrer">📝 Webpack HMR 原理解析（2017-11-08）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://zhuanlan.zhihu.com/p/30623057" target="_blank" rel="noopener noreferrer">📝 Webpack 热更新实现原理分析（2017-10-31）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://juejin.im/post/58f7fc7da0bb9f00659f7133" target="_blank" rel="noopener noreferrer">📝 Webpack 与 browser-sync 热更新原理深度讲解（2017-04-20）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://github.com/careteenL/webpack-hmr" target="_blank" rel="noopener noreferrer">🛠 搞懂 webpack 热更新原理：webpack-hmr<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/Webpack-Guidebook/edit/master/docs/principle-analysis/operational-principle/hot-module-replacement.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last Update: ">9/18/2020, 10:19:07 AM</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/webpack-guidebook/umi.js"></script>
    <script src="/webpack-guidebook/docs__principle-analysis__operational-principle__hot-module-replacement.md.js"></script>
  </body>
</html>
